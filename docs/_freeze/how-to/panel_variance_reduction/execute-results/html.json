{
  "hash": "267cca537983f576c50af3a59075a8ff",
  "result": {
    "engine": "jupyter",
    "markdown": "---\ntitle: \"Variance Reduction in AB Tests\"\ndescription: \"How to reduce the variance of estimators using exogenous control variables via CUPED, linear regression, and fixed effects estimators.\"\ncategories: [Panel, AB Testing]\n---\n\n## Panel Estimators for AB Tests with Repeated Observations\n\n::: {#8956d182 .cell execution_count=1}\n``` {.python .cell-code}\nimport numpy as np\nimport pandas as pd\nfrom IPython.display import display\nfrom tqdm import tqdm\n\nimport pyfixest as pf\nfrom pyfixest.utils.dgps import get_sharkfin\n```\n:::\n\n\nIn this tutorial, we show how to use pyfixest to reduce the variance of your estimators in AB tests with repeated observations.\n\nFor example, we may be a streaming platform and we want to estimate the effect of a new feature on the amount of time users spend watching videos. To do so,\nwe randomly assign the treatment to half of our users. For 15 days prior to the experiment, we track the desired outcome (minutes watched) for each user. If\nusers are not seen on the platform on a given day, the number of minutes watched is 0. Our experiment runs for 15 days. All in all, we have 30 days of data for each\nuser.\n\nTo get started, we simulate a panel data set of 100_000 users, with mentioned 30 days of data, with 15 days of pre and post data.\n\n::: {#bbecc94a .cell execution_count=2}\n``` {.python .cell-code}\ndef get_data(num_units: int, sigma_unit: int) -> pd.DataFrame:\n    \"\"\"\n    Random example data set.\n    num_units: int\n        The number of users\n    sigma_unit: int\n        The user-level idosyncratic error term.\n    \"\"\"\n    data = get_sharkfin(\n        num_units=100_000,\n        num_periods=30,\n        num_treated=500,\n        treatment_start=15,\n        seed=231,\n        sigma_unit=18,\n    )\n    data = data.rename(columns={\"Y\": \"minutes_watched\", \"unit\": \"user\", \"year\": \"day\"})\n\n    return data\n\n\ndata = get_data(num_units=100_000, sigma_unit=18)\ndata.head()\n```\n\n::: {.cell-output .cell-output-display execution_count=2}\n```{=html}\n<div>\n<style scoped>\n    .dataframe tbody tr th:only-of-type {\n        vertical-align: middle;\n    }\n\n    .dataframe tbody tr th {\n        vertical-align: top;\n    }\n\n    .dataframe thead th {\n        text-align: right;\n    }\n</style>\n<table border=\"1\" class=\"dataframe\">\n  <thead>\n    <tr style=\"text-align: right;\">\n      <th></th>\n      <th>user</th>\n      <th>day</th>\n      <th>treat</th>\n      <th>minutes_watched</th>\n      <th>ever_treated</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <th>0</th>\n      <td>0</td>\n      <td>0</td>\n      <td>0</td>\n      <td>8.114488</td>\n      <td>0</td>\n    </tr>\n    <tr>\n      <th>1</th>\n      <td>0</td>\n      <td>1</td>\n      <td>0</td>\n      <td>7.633058</td>\n      <td>0</td>\n    </tr>\n    <tr>\n      <th>2</th>\n      <td>0</td>\n      <td>2</td>\n      <td>0</td>\n      <td>6.712332</td>\n      <td>0</td>\n    </tr>\n    <tr>\n      <th>3</th>\n      <td>0</td>\n      <td>3</td>\n      <td>0</td>\n      <td>6.230820</td>\n      <td>0</td>\n    </tr>\n    <tr>\n      <th>4</th>\n      <td>0</td>\n      <td>4</td>\n      <td>0</td>\n      <td>6.004489</td>\n      <td>0</td>\n    </tr>\n  </tbody>\n</table>\n</div>\n```\n:::\n:::\n\n\nWe can inspect the data generating process via the `panelview()` function:\n\n::: {#01f04d6d .cell execution_count=3}\n``` {.python .cell-code}\npf.panelview(\n    data,\n    unit=\"user\",\n    time=\"day\",\n    treat=\"treat\",\n    collapse_to_cohort=True,\n    sort_by_timing=True,\n    ylab=\"Cohort\",\n    xlab=\"Day\",\n    title=\"Treatment Assignment Cohorts\",\n    figsize=(6, 5),\n)\n```\n\n::: {.cell-output .cell-output-display}\n```{=html}\n\n            <div id=\"A0rZuS\"></div>\n            <script type=\"text/javascript\" data-lets-plot-script=\"library\">\n                if(!window.letsPlotCallQueue) {\n                    window.letsPlotCallQueue = [];\n                }; \n                window.letsPlotCall = function(f) {\n                    window.letsPlotCallQueue.push(f);\n                };\n                (function() {\n                    var script = document.createElement(\"script\");\n                    script.type = \"text/javascript\";\n                    script.src = \"https://cdn.jsdelivr.net/gh/JetBrains/lets-plot@v4.7.3/js-package/distr/lets-plot.min.js\";\n                    script.onload = function() {\n                        window.letsPlotCall = function(f) {f();};\n                        window.letsPlotCallQueue.forEach(function(f) {f();});\n                        window.letsPlotCallQueue = [];\n                        \n                    };\n                    script.onerror = function(event) {\n                        window.letsPlotCall = function(f) {};    // noop\n                        window.letsPlotCallQueue = [];\n                        var div = document.createElement(\"div\");\n                        div.style.color = 'darkred';\n                        div.textContent = 'Error loading Lets-Plot JS';\n                        document.getElementById(\"A0rZuS\").appendChild(div);\n                    };\n                    var e = document.getElementById(\"A0rZuS\");\n                    e.appendChild(script);\n                })()\n            </script>\n            \n```\n:::\n\n::: {.cell-output .cell-output-display}\n```{=html}\n\n            <div id=\"SkfeW3\"></div>\n            <script type=\"text/javascript\" data-lets-plot-script=\"library\">\n                if(!window.letsPlotCallQueue) {\n                    window.letsPlotCallQueue = [];\n                }; \n                window.letsPlotCall = function(f) {\n                    window.letsPlotCallQueue.push(f);\n                };\n                (function() {\n                    var script = document.createElement(\"script\");\n                    script.type = \"text/javascript\";\n                    script.src = \"https://cdn.jsdelivr.net/gh/JetBrains/lets-plot@v4.7.3/js-package/distr/lets-plot.min.js\";\n                    script.onload = function() {\n                        window.letsPlotCall = function(f) {f();};\n                        window.letsPlotCallQueue.forEach(function(f) {f();});\n                        window.letsPlotCallQueue = [];\n                        \n                    };\n                    script.onerror = function(event) {\n                        window.letsPlotCall = function(f) {};    // noop\n                        window.letsPlotCallQueue = [];\n                        var div = document.createElement(\"div\");\n                        div.style.color = 'darkred';\n                        div.textContent = 'Error loading Lets-Plot JS';\n                        document.getElementById(\"SkfeW3\").appendChild(div);\n                    };\n                    var e = document.getElementById(\"SkfeW3\");\n                    e.appendChild(script);\n                })()\n            </script>\n            \n```\n:::\n\n::: {.cell-output .cell-output-display}\n![](panel_variance_reduction_files/figure-html/cell-4-output-3.png){width=502 height=454}\n:::\n:::\n\n\nWe see that half of our users are treated after half the time.\n\nIn the next step, we will look at three different ways to compute the average treatment effect of our feature on the outcome:\n\n- First, we will compute a standard \"difference in means\" estimator and conduct a two-sampled t-test for inference. We do this both by hand and by means of linear regression. While standard, we will show that this estimator is relatively inefficient\n  as it throws aways valuable information from the pre-treatment periods.\n- In a second step, we improve on the difference in means estimator and include pre-treatment measures of the outcome variable to our regression model. In the tech blog world, this method\n  is often referred to as CUPED (which stands for \"Controlled-experiment Using Pre-Experiment Data\" as far as we know). We will demonstrate that CUPED uted leads to a significant reduction in the variance of our estimators. Pre-treatment averages are a \"good control\" variable because\n  a) under uncondional randomization, pre-treatment averages should be uncorrelated of the treatment assignment and b) pre-treatment averages should be highly predictive of the post-treatment outcome. The intuition here is simply that users will behave similarly \"after\" the experiment starts / when receiving the treatment than they did before.\n- In a third step, we show that instead of using pre-treatment averages as a control variable, we can simply fit a panel model and control for user and time fixed effect.\n\nAll three estimators identify the same average treatment effect, but the CUPED and panel estimator are much more efficient: they produce lower variances.\n\nBut first, let's discuss why we are interested in reducing the variance of our estimators.\n\n## Variance of Estimators, Statistical Power and Sample Size Requirements\n\nIn statistical experiments, we care about power to make sure that we detect a true effect.\n\nIt depends on the **signal-to-noise ratio**:\n\n$$\n\\text{Power} \\;\\sim\\; f\\!\\left(\\frac{|\\tau|}{\\text{SE}}\\right)\n$$\n\nwhere\n\n- $\\tau$ = the true effect size\n- $\\text{SE} = \\frac{\\sigma}{\\sqrt{n}}$ = the standard error of the estimate\n- $\\sigma$ = standard deviation of the outcome\n- $n$ = sample size per group (if balanced)\n\nSo, anything that **increases the effect size**, **increases the sample size**, or **reduces outcome variance** will improve power. That's where our interest in variance reduction stems from.\n\n## Simple Difference in Means Estimator\n\nThe simplest way to analyse an AB test / estimate an average treatment effect is the difference in means estimator:\n$$\n    \\tau = \\frac{1}{n_1} \\sum_{i=1}^{n_1} Y_{i,1} - \\frac{1}{n_0} \\sum_{i=1}^{n_0}  Y_{i,0}\n$$\n\nWe can compute it in a few lines of `pandas` by implementing three steps:\n- First, we throw away all pre-experimental data.\n- Then, we sum the post-treatment minutes watched into a single data point per user.\n- Finally, we compute the difference of means of total minutes watched between the treated and control group.\nDone!\n\n::: {#7ce9c5f8 .cell execution_count=4}\n``` {.python .cell-code}\ndef _difference_in_means_pd(data):\n    # standard analyses: throw away pre-experimental data\n    data2 = data.copy()\n    data_post = data2[data2.day >= 15]\n    # collapse post-treatment minutes watched into a single data point per user\n    data_post_agg = (\n        data_post.groupby([\"user\", \"treat\"])\n        .agg({\"minutes_watched\": \"mean\"})\n        .reset_index()\n        .rename(columns={\"minutes_watched\": \"total_minutes_watched\"})\n    )\n    # compute difference of means estimator\n    return data_post_agg.groupby(\"treat\").mean().diff()\n\n\n_difference_in_means_pd(data)\n```\n\n::: {.cell-output .cell-output-display execution_count=4}\n```{=html}\n<div>\n<style scoped>\n    .dataframe tbody tr th:only-of-type {\n        vertical-align: middle;\n    }\n\n    .dataframe tbody tr th {\n        vertical-align: top;\n    }\n\n    .dataframe thead th {\n        text-align: right;\n    }\n</style>\n<table border=\"1\" class=\"dataframe\">\n  <thead>\n    <tr style=\"text-align: right;\">\n      <th></th>\n      <th>user</th>\n      <th>total_minutes_watched</th>\n    </tr>\n    <tr>\n      <th>treat</th>\n      <th></th>\n      <th></th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <th>0</th>\n      <td>NaN</td>\n      <td>NaN</td>\n    </tr>\n    <tr>\n      <th>1</th>\n      <td>-1387.630151</td>\n      <td>0.761514</td>\n    </tr>\n  </tbody>\n</table>\n</div>\n```\n:::\n:::\n\n\nBecause linear regression is just a fency way to compute and compare differences, we could also have estimated this via `pf.feols()`:\n\n::: {#6beeebc7 .cell execution_count=5}\n``` {.python .cell-code}\ndef _difference_in_means(data):\n    data2 = data.copy()\n\n    data_post = data2[data2.day >= 15]\n    fit = pf.feols(\"minutes_watched ~ treat\", data=data_post)\n\n    return fit\n\n\nfit_difference_in_means = _difference_in_means(data)\nfit_difference_in_means.summary()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n###\n\nEstimation:  OLS\nDep. var.: minutes_watched, Fixed effects: 0\nInference:  iid\nObservations:  1500000\n\n| Coefficient   |   Estimate |   Std. Error |   t value |   Pr(>|t|) |   2.5% |   97.5% |\n|:--------------|-----------:|-------------:|----------:|-----------:|-------:|--------:|\n| Intercept     |      0.357 |        0.015 |    24.163 |      0.000 |  0.328 |   0.386 |\n| treat         |      0.762 |        0.209 |     3.641 |      0.000 |  0.352 |   1.171 |\n---\nRMSE: 18.07 R2: 0.0 \n```\n:::\n:::\n\n\nNote that no aggregation step is needed and that we get identical point estimates. As a bonus, we get standard errors and confidence intervals in the process.\n\n## Cuped: Using Pre-Experimental Measures of the Outcomes Variable as Controls\n\nSometimes, throwing away data can be a winning strategy (\"garbage in garbage out\"), but not in this example: we have high-quality pre-experimental measures of the behavior\nof our users at hand, and we should use it in our favor!\n\nMore specifically, instead of throwing away all of the pre-experimental measures, we could instead have used them as a control!\n\nThis should help reduce the variance of our estimators because pre-experimental behavior is likely to be highly predicitive of what users do after the launch of the experiment. Consequently, including these baselines in our regression models should help us \"explain residual errors\" and thereby reduce the variance of our\nestimators.\n\nIf this works, it's great news, as it allows us to run the same experiment on a smaller number of users and still achieve the same level of power!\n\n::: {#f78f064d .cell execution_count=6}\n``` {.python .cell-code}\ndef _regression_cuped(data):\n    data = data.copy()\n    data[\"pre_experiment\"] = data[\"day\"] < 15\n\n    # aggregate pre-post averages by user\n    agg = data.groupby([\"user\", \"pre_experiment\"], as_index=False).agg(\n        minutes_watched=(\"minutes_watched\", \"mean\")\n    )\n\n    wide = (\n        agg.pivot(index=\"user\", columns=\"pre_experiment\", values=\"minutes_watched\")\n        .rename(columns={True: \"minutes_pre\", False: \"minutes_post\"})\n        .reset_index()\n    )\n\n    wide = wide.merge(\n        data[[\"user\", \"ever_treated\"]].drop_duplicates(), on=\"user\", how=\"left\"\n    ).rename(columns={\"ever_treated\": \"treat\"})\n\n    # center the pre metric\n    mu_pre = wide[\"minutes_pre\"].mean()\n    wide[\"minutes_pre_c\"] = wide[\"minutes_pre\"] - mu_pre\n\n    fit_cuped = pf.feols(\n        \"minutes_post ~ treat + minutes_pre_c\", data=wide, vcov=\"hetero\"\n    )\n\n    return fit_cuped, wide\n\n\nfit_cuped, data_cuped = _regression_cuped(data)\n```\n:::\n\n\nPer user, we now log the total minutes watched before and after the treatment and then fit a regression model of the following form:\n\n$$\n    \\text{total minutes watched after treatment} = \\alpha + \\beta \\text{treat} + \\gamma (\\text{total minutes watched before treatment} - \\text{avg total minutes watched before treatment}) + \\epsilon\n$$\n\n::: {#6964d13f .cell execution_count=7}\n``` {.python .cell-code}\ndata_cuped.head()\n```\n\n::: {.cell-output .cell-output-display execution_count=7}\n```{=html}\n<div>\n<style scoped>\n    .dataframe tbody tr th:only-of-type {\n        vertical-align: middle;\n    }\n\n    .dataframe tbody tr th {\n        vertical-align: top;\n    }\n\n    .dataframe thead th {\n        text-align: right;\n    }\n</style>\n<table border=\"1\" class=\"dataframe\">\n  <thead>\n    <tr style=\"text-align: right;\">\n      <th></th>\n      <th>user</th>\n      <th>minutes_post</th>\n      <th>minutes_pre</th>\n      <th>treat</th>\n      <th>minutes_pre_c</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <th>0</th>\n      <td>0</td>\n      <td>7.747841</td>\n      <td>7.767178</td>\n      <td>0</td>\n      <td>7.894779</td>\n    </tr>\n    <tr>\n      <th>1</th>\n      <td>1</td>\n      <td>25.595928</td>\n      <td>24.674535</td>\n      <td>0</td>\n      <td>24.802136</td>\n    </tr>\n    <tr>\n      <th>2</th>\n      <td>2</td>\n      <td>-32.224392</td>\n      <td>-32.130334</td>\n      <td>0</td>\n      <td>-32.002733</td>\n    </tr>\n    <tr>\n      <th>3</th>\n      <td>3</td>\n      <td>-12.269762</td>\n      <td>-13.142435</td>\n      <td>0</td>\n      <td>-13.014835</td>\n    </tr>\n    <tr>\n      <th>4</th>\n      <td>4</td>\n      <td>-1.448348</td>\n      <td>-1.392043</td>\n      <td>0</td>\n      <td>-1.264442</td>\n    </tr>\n  </tbody>\n</table>\n</div>\n```\n:::\n:::\n\n\nWe can compare with the previous results:\n\n::: {#aa241b69 .cell execution_count=8}\n``` {.python .cell-code}\npf.etable([fit_difference_in_means, fit_cuped])\n```\n\n::: {.cell-output .cell-output-display execution_count=8}\n```{=html}\n<div id=\"eptxntidtl\" style=\"padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;\">\n<style>\n#eptxntidtl table {\n          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', 'Fira Sans', 'Droid Sans', Arial, sans-serif;\n          -webkit-font-smoothing: antialiased;\n          -moz-osx-font-smoothing: grayscale;\n        }\n\n#eptxntidtl thead, tbody, tfoot, tr, td, th { border-style: none; }\n tr { background-color: transparent; }\n#eptxntidtl p { margin: 0; padding: 0; }\n #eptxntidtl .gt_table { display: table; border-collapse: collapse; line-height: normal; margin-left: auto; margin-right: auto; color: #333333; font-size: 16px; font-weight: normal; font-style: normal; background-color: #FFFFFF; width: auto; border-top-style: solid; border-top-width: 2px; border-top-color: #A8A8A8; border-right-style: none; border-right-width: 2px; border-right-color: #D3D3D3; border-bottom-style: hidden; border-bottom-width: 2px; border-bottom-color: #A8A8A8; border-left-style: none; border-left-width: 2px; border-left-color: #D3D3D3; }\n #eptxntidtl .gt_caption { padding-top: 4px; padding-bottom: 4px; }\n #eptxntidtl .gt_title { color: #333333; font-size: 16px; font-weight: initial; padding-top: 6px; padding-bottom: 6px; padding-left: 5px; padding-right: 5px; border-bottom-color: #FFFFFF; border-bottom-width: 0; }\n #eptxntidtl .gt_subtitle { color: #333333; font-size: 85%; font-weight: initial; padding-top: 5px; padding-bottom: 7px; padding-left: 5px; padding-right: 5px; border-top-color: #FFFFFF; border-top-width: 0; }\n #eptxntidtl .gt_heading { background-color: #FFFFFF; text-align: center; border-bottom-color: #FFFFFF; border-left-style: none; border-left-width: 1px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 1px; border-right-color: #D3D3D3; }\n #eptxntidtl .gt_bottom_border { border-bottom-style: solid; border-bottom-width: 2px; border-bottom-color: #D3D3D3; }\n #eptxntidtl .gt_col_headings { border-top-style: solid; border-top-width: 2px; border-top-color: black; border-bottom-style: solid; border-bottom-width: 0.25px; border-bottom-color: black; border-left-style: none; border-left-width: 1px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 1px; border-right-color: #D3D3D3; }\n #eptxntidtl .gt_col_heading { color: #333333; background-color: #FFFFFF; font-size: 16px; font-weight: normal; text-transform: inherit; border-left-style: none; border-left-width: 0px; border-left-color: white; border-right-style: none; border-right-width: 0px; border-right-color: white; vertical-align: bottom; padding-top: 2px; padding-bottom: 7px; padding-left: 5px; padding-right: 5px; overflow-x: hidden; }\n #eptxntidtl .gt_column_spanner_outer { color: #333333; background-color: #FFFFFF; font-size: 16px; font-weight: normal; text-transform: inherit; padding-top: 0; padding-bottom: 0; padding-left: 4px; padding-right: 4px; }\n #eptxntidtl .gt_column_spanner_outer:first-child { padding-left: 0; }\n #eptxntidtl .gt_column_spanner_outer:last-child { padding-right: 0; }\n #eptxntidtl .gt_column_spanner { border-bottom-style: solid; border-bottom-width: 0.25px; border-bottom-color: black; vertical-align: bottom; padding-top: 2px; padding-bottom: 2px; overflow-x: hidden; display: inline-block; width: 100%; }\n #eptxntidtl .gt_spanner_row { border-bottom-style: hidden; }\n #eptxntidtl .gt_group_heading { padding-top: 0px; padding-bottom: 0px; padding-left: 5px; padding-right: 5px; color: #333333; background-color: #FFFFFF; font-size: 0px; font-weight: initial; text-transform: inherit; border-top-style: solid; border-top-width: 0.25px; border-top-color: black; border-bottom-style: solid; border-bottom-width: 0.25px; border-bottom-color: black; border-left-style: none; border-left-width: 1px; border-left-color: white; border-right-style: none; border-right-width: 1px; border-right-color: white; vertical-align: middle; text-align: left; }\n #eptxntidtl .gt_empty_group_heading { padding: 0.5px; color: #333333; background-color: #FFFFFF; font-size: 0px; font-weight: initial; border-top-style: solid; border-top-width: 0.25px; border-top-color: black; border-bottom-style: solid; border-bottom-width: 0.25px; border-bottom-color: black; vertical-align: middle; }\n #eptxntidtl .gt_from_md> :first-child { margin-top: 0; }\n #eptxntidtl .gt_from_md> :last-child { margin-bottom: 0; }\n #eptxntidtl .gt_row { padding-top: 2px; padding-bottom: 2px; padding-left: 5px; padding-right: 5px; margin: 10px; border-top-style: none; border-top-width: 1px; border-top-color: #D3D3D3; border-left-style: none; border-left-width: 0px; border-left-color: white; border-right-style: none; border-right-width: 0px; border-right-color: white; vertical-align: middle; overflow-x: hidden; }\n #eptxntidtl .gt_stub { color: #333333; background-color: #FFFFFF; font-size: 16px; font-weight: initial; text-transform: inherit; border-right-style: hidden; border-right-width: 2px; border-right-color: #D3D3D3; padding-left: 5px; padding-right: 5px; }\n #eptxntidtl .gt_stub_row_group { color: #333333; background-color: #FFFFFF; font-size: 100%; font-weight: initial; text-transform: inherit; border-right-style: solid; border-right-width: 2px; border-right-color: #D3D3D3; padding-left: 5px; padding-right: 5px; vertical-align: top; }\n #eptxntidtl .gt_row_group_first td { border-top-width: 0.25px; }\n #eptxntidtl .gt_row_group_first th { border-top-width: 0.25px; }\n #eptxntidtl .gt_striped { color: #333333; background-color: #F4F4F4; }\n #eptxntidtl .gt_table_body { border-top-style: solid; border-top-width: 0px; border-top-color: black; border-bottom-style: solid; border-bottom-width: 2px; border-bottom-color: black; }\n #eptxntidtl .gt_grand_summary_row { color: #333333; background-color: #FFFFFF; text-transform: inherit; padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; }\n #eptxntidtl .gt_first_grand_summary_row_bottom { border-top-style: double; border-top-width: 6px; border-top-color: #D3D3D3; }\n #eptxntidtl .gt_last_grand_summary_row_top { border-bottom-style: double; border-bottom-width: 6px; border-bottom-color: #D3D3D3; }\n #eptxntidtl .gt_sourcenotes { color: #333333; background-color: #FFFFFF; border-bottom-style: none; border-bottom-width: 2px; border-bottom-color: #D3D3D3; border-left-style: none; border-left-width: 2px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 2px; border-right-color: #D3D3D3; }\n #eptxntidtl .gt_sourcenote { font-size: 10px; padding-top: 4px; padding-bottom: 4px; padding-left: 5px; padding-right: 5px; text-align: left; }\n #eptxntidtl .gt_left { text-align: left; }\n #eptxntidtl .gt_center { text-align: center; }\n #eptxntidtl .gt_right { text-align: right; font-variant-numeric: tabular-nums; }\n #eptxntidtl .gt_font_normal { font-weight: normal; }\n #eptxntidtl .gt_font_bold { font-weight: bold; }\n #eptxntidtl .gt_font_italic { font-style: italic; }\n #eptxntidtl .gt_super { font-size: 65%; }\n #eptxntidtl .gt_footnote_marks { font-size: 75%; vertical-align: 0.4em; position: initial; }\n #eptxntidtl .gt_asterisk { font-size: 100%; vertical-align: 0; }\n \n</style>\n<table class=\"gt_table\" data-quarto-disable-processing=\"false\" data-quarto-bootstrap=\"false\">\n<thead>\n\n<tr class=\"gt_col_headings gt_spanner_row\">\n  <th class=\"gt_col_heading gt_columns_bottom_border gt_left\" rowspan=\"2\" colspan=\"1\" scope=\"col\" id=\"\"></th>\n  <th class=\"gt_center gt_columns_top_border gt_column_spanner_outer\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"minutes_watched\">\n    <span class=\"gt_column_spanner\">minutes_watched</span>\n  </th>\n  <th class=\"gt_center gt_columns_top_border gt_column_spanner_outer\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"minutes_post\">\n    <span class=\"gt_column_spanner\">minutes_post</span>\n  </th>\n</tr>\n<tr class=\"gt_col_headings\">\n  <th class=\"gt_col_heading gt_columns_bottom_border gt_center\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"0\">(1)</th>\n  <th class=\"gt_col_heading gt_columns_bottom_border gt_center\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"1\">(2)</th>\n</tr>\n</thead>\n<tbody class=\"gt_table_body\">\n  <tr class=\"gt_group_heading_row\">\n    <th class=\"gt_group_heading\" colspan=\"3\">coef</th>\n  </tr>\n  <tr>\n    <th class=\"gt_row gt_left gt_stub\">treat</th>\n    <td class=\"gt_row gt_center\">0.762*** <br> (0.209)</td>\n    <td class=\"gt_row gt_center\">0.192*** <br> (0.029)</td>\n  </tr>\n  <tr>\n    <th class=\"gt_row gt_left gt_stub\">minutes_pre_c</th>\n    <td class=\"gt_row gt_center\"></td>\n    <td class=\"gt_row gt_center\">0.999*** <br> (0.000116)</td>\n  </tr>\n  <tr>\n    <th class=\"gt_row gt_left gt_stub\">Intercept</th>\n    <td class=\"gt_row gt_center\">0.357*** <br> (0.015)</td>\n    <td class=\"gt_row gt_center\">0.36*** <br> (0.002)</td>\n  </tr>\n  <tr class=\"gt_group_heading_row\">\n    <th class=\"gt_group_heading\" colspan=\"3\">stats</th>\n  </tr>\n  <tr>\n    <th class=\"gt_row gt_left gt_stub\">Observations</th>\n    <td class=\"gt_row gt_center\">1,500,000</td>\n    <td class=\"gt_row gt_center\">100,000</td>\n  </tr>\n  <tr>\n    <th class=\"gt_row gt_left gt_stub\">R<sup>2</sup></th>\n    <td class=\"gt_row gt_center\">0.000009</td>\n    <td class=\"gt_row gt_center\">0.999</td>\n  </tr>\n</tbody>\n  <tfoot class=\"gt_sourcenotes\">\n  \n  <tr>\n    <td class=\"gt_sourcenote\" colspan=\"3\">Significance levels: * p &lt; 0.05, ** p &lt; 0.01, *** p &lt; 0.001. Format of coefficient cell: Coefficient   (Std. Error)</td>\n  </tr>\n\n</tfoot>\n\n</table>\n\n</div>\n        \n```\n:::\n:::\n\n\nPoint estimates for the difference-in-means estimator is 0.762, while it is 0.192 for the Cuped estimator. But most importantly, the standard errors are much smaller for the CUPED estimator (0.03 vs 0.209). Because we have fitted a regression model with covariates, we have used heteroskedasticity-robust standard errors, which should be more conservative than the iid errors used in the difference-in-means regression.\n\n## Panel Estimator\n\nInstead of collapsing all pre-and post information into a single average (and thereby losing information), we can as well be lazy and just use a panel estimator.\n\nVia `pyfixest`, that's one line of code:\n\n::: {#8388bae5 .cell execution_count=9}\n``` {.python .cell-code}\nfit_panel = pf.feols(\n    \"minutes_watched ~ treat | user + day\",\n    data=data,\n    vcov=\"hetero\",\n    demeaner_backend=\"rust\",\n)\n```\n:::\n\n\nWe can compare all results:\n\n::: {#b3cb8339 .cell execution_count=10}\n``` {.python .cell-code}\npf.etable([fit_difference_in_means, fit_cuped, fit_panel])\n```\n\n::: {.cell-output .cell-output-display execution_count=10}\n```{=html}\n<div id=\"mfmxbgtasr\" style=\"padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;\">\n<style>\n#mfmxbgtasr table {\n          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', 'Fira Sans', 'Droid Sans', Arial, sans-serif;\n          -webkit-font-smoothing: antialiased;\n          -moz-osx-font-smoothing: grayscale;\n        }\n\n#mfmxbgtasr thead, tbody, tfoot, tr, td, th { border-style: none; }\n tr { background-color: transparent; }\n#mfmxbgtasr p { margin: 0; padding: 0; }\n #mfmxbgtasr .gt_table { display: table; border-collapse: collapse; line-height: normal; margin-left: auto; margin-right: auto; color: #333333; font-size: 16px; font-weight: normal; font-style: normal; background-color: #FFFFFF; width: auto; border-top-style: solid; border-top-width: 2px; border-top-color: #A8A8A8; border-right-style: none; border-right-width: 2px; border-right-color: #D3D3D3; border-bottom-style: hidden; border-bottom-width: 2px; border-bottom-color: #A8A8A8; border-left-style: none; border-left-width: 2px; border-left-color: #D3D3D3; }\n #mfmxbgtasr .gt_caption { padding-top: 4px; padding-bottom: 4px; }\n #mfmxbgtasr .gt_title { color: #333333; font-size: 16px; font-weight: initial; padding-top: 6px; padding-bottom: 6px; padding-left: 5px; padding-right: 5px; border-bottom-color: #FFFFFF; border-bottom-width: 0; }\n #mfmxbgtasr .gt_subtitle { color: #333333; font-size: 85%; font-weight: initial; padding-top: 5px; padding-bottom: 7px; padding-left: 5px; padding-right: 5px; border-top-color: #FFFFFF; border-top-width: 0; }\n #mfmxbgtasr .gt_heading { background-color: #FFFFFF; text-align: center; border-bottom-color: #FFFFFF; border-left-style: none; border-left-width: 1px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 1px; border-right-color: #D3D3D3; }\n #mfmxbgtasr .gt_bottom_border { border-bottom-style: solid; border-bottom-width: 2px; border-bottom-color: #D3D3D3; }\n #mfmxbgtasr .gt_col_headings { border-top-style: solid; border-top-width: 2px; border-top-color: black; border-bottom-style: solid; border-bottom-width: 0.25px; border-bottom-color: black; border-left-style: none; border-left-width: 1px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 1px; border-right-color: #D3D3D3; }\n #mfmxbgtasr .gt_col_heading { color: #333333; background-color: #FFFFFF; font-size: 16px; font-weight: normal; text-transform: inherit; border-left-style: none; border-left-width: 0px; border-left-color: white; border-right-style: none; border-right-width: 0px; border-right-color: white; vertical-align: bottom; padding-top: 2px; padding-bottom: 7px; padding-left: 5px; padding-right: 5px; overflow-x: hidden; }\n #mfmxbgtasr .gt_column_spanner_outer { color: #333333; background-color: #FFFFFF; font-size: 16px; font-weight: normal; text-transform: inherit; padding-top: 0; padding-bottom: 0; padding-left: 4px; padding-right: 4px; }\n #mfmxbgtasr .gt_column_spanner_outer:first-child { padding-left: 0; }\n #mfmxbgtasr .gt_column_spanner_outer:last-child { padding-right: 0; }\n #mfmxbgtasr .gt_column_spanner { border-bottom-style: solid; border-bottom-width: 0.25px; border-bottom-color: black; vertical-align: bottom; padding-top: 2px; padding-bottom: 2px; overflow-x: hidden; display: inline-block; width: 100%; }\n #mfmxbgtasr .gt_spanner_row { border-bottom-style: hidden; }\n #mfmxbgtasr .gt_group_heading { padding-top: 0px; padding-bottom: 0px; padding-left: 5px; padding-right: 5px; color: #333333; background-color: #FFFFFF; font-size: 0px; font-weight: initial; text-transform: inherit; border-top-style: solid; border-top-width: 0.25px; border-top-color: black; border-bottom-style: solid; border-bottom-width: 0.25px; border-bottom-color: black; border-left-style: none; border-left-width: 1px; border-left-color: white; border-right-style: none; border-right-width: 1px; border-right-color: white; vertical-align: middle; text-align: left; }\n #mfmxbgtasr .gt_empty_group_heading { padding: 0.5px; color: #333333; background-color: #FFFFFF; font-size: 0px; font-weight: initial; border-top-style: solid; border-top-width: 0.25px; border-top-color: black; border-bottom-style: solid; border-bottom-width: 0.25px; border-bottom-color: black; vertical-align: middle; }\n #mfmxbgtasr .gt_from_md> :first-child { margin-top: 0; }\n #mfmxbgtasr .gt_from_md> :last-child { margin-bottom: 0; }\n #mfmxbgtasr .gt_row { padding-top: 2px; padding-bottom: 2px; padding-left: 5px; padding-right: 5px; margin: 10px; border-top-style: none; border-top-width: 1px; border-top-color: #D3D3D3; border-left-style: none; border-left-width: 0px; border-left-color: white; border-right-style: none; border-right-width: 0px; border-right-color: white; vertical-align: middle; overflow-x: hidden; }\n #mfmxbgtasr .gt_stub { color: #333333; background-color: #FFFFFF; font-size: 16px; font-weight: initial; text-transform: inherit; border-right-style: hidden; border-right-width: 2px; border-right-color: #D3D3D3; padding-left: 5px; padding-right: 5px; }\n #mfmxbgtasr .gt_stub_row_group { color: #333333; background-color: #FFFFFF; font-size: 100%; font-weight: initial; text-transform: inherit; border-right-style: solid; border-right-width: 2px; border-right-color: #D3D3D3; padding-left: 5px; padding-right: 5px; vertical-align: top; }\n #mfmxbgtasr .gt_row_group_first td { border-top-width: 0.25px; }\n #mfmxbgtasr .gt_row_group_first th { border-top-width: 0.25px; }\n #mfmxbgtasr .gt_striped { color: #333333; background-color: #F4F4F4; }\n #mfmxbgtasr .gt_table_body { border-top-style: solid; border-top-width: 0px; border-top-color: black; border-bottom-style: solid; border-bottom-width: 2px; border-bottom-color: black; }\n #mfmxbgtasr .gt_grand_summary_row { color: #333333; background-color: #FFFFFF; text-transform: inherit; padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; }\n #mfmxbgtasr .gt_first_grand_summary_row_bottom { border-top-style: double; border-top-width: 6px; border-top-color: #D3D3D3; }\n #mfmxbgtasr .gt_last_grand_summary_row_top { border-bottom-style: double; border-bottom-width: 6px; border-bottom-color: #D3D3D3; }\n #mfmxbgtasr .gt_sourcenotes { color: #333333; background-color: #FFFFFF; border-bottom-style: none; border-bottom-width: 2px; border-bottom-color: #D3D3D3; border-left-style: none; border-left-width: 2px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 2px; border-right-color: #D3D3D3; }\n #mfmxbgtasr .gt_sourcenote { font-size: 10px; padding-top: 4px; padding-bottom: 4px; padding-left: 5px; padding-right: 5px; text-align: left; }\n #mfmxbgtasr .gt_left { text-align: left; }\n #mfmxbgtasr .gt_center { text-align: center; }\n #mfmxbgtasr .gt_right { text-align: right; font-variant-numeric: tabular-nums; }\n #mfmxbgtasr .gt_font_normal { font-weight: normal; }\n #mfmxbgtasr .gt_font_bold { font-weight: bold; }\n #mfmxbgtasr .gt_font_italic { font-style: italic; }\n #mfmxbgtasr .gt_super { font-size: 65%; }\n #mfmxbgtasr .gt_footnote_marks { font-size: 75%; vertical-align: 0.4em; position: initial; }\n #mfmxbgtasr .gt_asterisk { font-size: 100%; vertical-align: 0; }\n \n</style>\n<table class=\"gt_table\" data-quarto-disable-processing=\"false\" data-quarto-bootstrap=\"false\">\n<thead>\n\n<tr class=\"gt_col_headings gt_spanner_row\">\n  <th class=\"gt_col_heading gt_columns_bottom_border gt_left\" rowspan=\"2\" colspan=\"1\" scope=\"col\" id=\"\"></th>\n  <th class=\"gt_center gt_columns_top_border gt_column_spanner_outer\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"minutes_watched\">\n    <span class=\"gt_column_spanner\">minutes_watched</span>\n  </th>\n  <th class=\"gt_center gt_columns_top_border gt_column_spanner_outer\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"minutes_post\">\n    <span class=\"gt_column_spanner\">minutes_post</span>\n  </th>\n  <th class=\"gt_center gt_columns_top_border gt_column_spanner_outer\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"minutes_watched\">\n    <span class=\"gt_column_spanner\">minutes_watched</span>\n  </th>\n</tr>\n<tr class=\"gt_col_headings\">\n  <th class=\"gt_col_heading gt_columns_bottom_border gt_center\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"0\">(1)</th>\n  <th class=\"gt_col_heading gt_columns_bottom_border gt_center\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"1\">(2)</th>\n  <th class=\"gt_col_heading gt_columns_bottom_border gt_center\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"2\">(3)</th>\n</tr>\n</thead>\n<tbody class=\"gt_table_body\">\n  <tr class=\"gt_group_heading_row\">\n    <th class=\"gt_group_heading\" colspan=\"4\">coef</th>\n  </tr>\n  <tr>\n    <th class=\"gt_row gt_left gt_stub\">treat</th>\n    <td class=\"gt_row gt_center\">0.762*** <br> (0.209)</td>\n    <td class=\"gt_row gt_center\">0.192*** <br> (0.029)</td>\n    <td class=\"gt_row gt_center\">0.191*** <br> (0.012)</td>\n  </tr>\n  <tr>\n    <th class=\"gt_row gt_left gt_stub\">minutes_pre_c</th>\n    <td class=\"gt_row gt_center\"></td>\n    <td class=\"gt_row gt_center\">0.999*** <br> (0.000116)</td>\n    <td class=\"gt_row gt_center\"></td>\n  </tr>\n  <tr>\n    <th class=\"gt_row gt_left gt_stub\">Intercept</th>\n    <td class=\"gt_row gt_center\">0.357*** <br> (0.015)</td>\n    <td class=\"gt_row gt_center\">0.36*** <br> (0.002)</td>\n    <td class=\"gt_row gt_center\"></td>\n  </tr>\n  <tr class=\"gt_group_heading_row\">\n    <th class=\"gt_group_heading\" colspan=\"4\">fe</th>\n  </tr>\n  <tr>\n    <th class=\"gt_row gt_left gt_stub\">day</th>\n    <td class=\"gt_row gt_center\">-</td>\n    <td class=\"gt_row gt_center\">-</td>\n    <td class=\"gt_row gt_center\">x</td>\n  </tr>\n  <tr>\n    <th class=\"gt_row gt_left gt_stub\">user</th>\n    <td class=\"gt_row gt_center\">-</td>\n    <td class=\"gt_row gt_center\">-</td>\n    <td class=\"gt_row gt_center\">x</td>\n  </tr>\n  <tr class=\"gt_group_heading_row\">\n    <th class=\"gt_group_heading\" colspan=\"4\">stats</th>\n  </tr>\n  <tr>\n    <th class=\"gt_row gt_left gt_stub\">Observations</th>\n    <td class=\"gt_row gt_center\">1,500,000</td>\n    <td class=\"gt_row gt_center\">100,000</td>\n    <td class=\"gt_row gt_center\">3,000,000</td>\n  </tr>\n  <tr>\n    <th class=\"gt_row gt_left gt_stub\">R<sup>2</sup></th>\n    <td class=\"gt_row gt_center\">0.000009</td>\n    <td class=\"gt_row gt_center\">0.999</td>\n    <td class=\"gt_row gt_center\">0.999</td>\n  </tr>\n</tbody>\n  <tfoot class=\"gt_sourcenotes\">\n  \n  <tr>\n    <td class=\"gt_sourcenote\" colspan=\"4\">Significance levels: * p &lt; 0.05, ** p &lt; 0.01, *** p &lt; 0.001. Format of coefficient cell: Coefficient   (Std. Error)</td>\n  </tr>\n\n</tfoot>\n\n</table>\n\n</div>\n        \n```\n:::\n:::\n\n\nThe panel estimator almost exactly matches CUPED, and we do even better in terms of variance.\n\nHowever, because we are working with panel data, the error terms are likely correlated over time within each user. If we ignore this dependence, our standard errors may be underestimated, which in turn can lead to over-rejecting the null hypothesis of no effect. A common way to address this issue is to compute cluster-robust standard errors at the user level, which account for arbitrary heteroskedasticity and autocorrelation within users.\n\n::: {#1a7c0221 .cell execution_count=11}\n``` {.python .cell-code}\nfit_panel_crv = pf.feols(\n    \"minutes_watched ~ treat | user + day\",\n    data=data,\n    vcov={\"CRV1\": \"user\"},\n    demeaner_backend=\"rust\",\n)\n```\n:::\n\n\nComparing all results, the panel estimator still does quite well in terms of the size of the estimated standard errors.\n\n::: {#6f1d7e84 .cell execution_count=12}\n``` {.python .cell-code}\npf.etable(\n    [fit_difference_in_means, fit_cuped, fit_panel, fit_panel_crv],\n    digits=4,\n)\n```\n\n::: {.cell-output .cell-output-display execution_count=12}\n```{=html}\n<div id=\"htfykocrmc\" style=\"padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;\">\n<style>\n#htfykocrmc table {\n          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', 'Fira Sans', 'Droid Sans', Arial, sans-serif;\n          -webkit-font-smoothing: antialiased;\n          -moz-osx-font-smoothing: grayscale;\n        }\n\n#htfykocrmc thead, tbody, tfoot, tr, td, th { border-style: none; }\n tr { background-color: transparent; }\n#htfykocrmc p { margin: 0; padding: 0; }\n #htfykocrmc .gt_table { display: table; border-collapse: collapse; line-height: normal; margin-left: auto; margin-right: auto; color: #333333; font-size: 16px; font-weight: normal; font-style: normal; background-color: #FFFFFF; width: auto; border-top-style: solid; border-top-width: 2px; border-top-color: #A8A8A8; border-right-style: none; border-right-width: 2px; border-right-color: #D3D3D3; border-bottom-style: hidden; border-bottom-width: 2px; border-bottom-color: #A8A8A8; border-left-style: none; border-left-width: 2px; border-left-color: #D3D3D3; }\n #htfykocrmc .gt_caption { padding-top: 4px; padding-bottom: 4px; }\n #htfykocrmc .gt_title { color: #333333; font-size: 16px; font-weight: initial; padding-top: 6px; padding-bottom: 6px; padding-left: 5px; padding-right: 5px; border-bottom-color: #FFFFFF; border-bottom-width: 0; }\n #htfykocrmc .gt_subtitle { color: #333333; font-size: 85%; font-weight: initial; padding-top: 5px; padding-bottom: 7px; padding-left: 5px; padding-right: 5px; border-top-color: #FFFFFF; border-top-width: 0; }\n #htfykocrmc .gt_heading { background-color: #FFFFFF; text-align: center; border-bottom-color: #FFFFFF; border-left-style: none; border-left-width: 1px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 1px; border-right-color: #D3D3D3; }\n #htfykocrmc .gt_bottom_border { border-bottom-style: solid; border-bottom-width: 2px; border-bottom-color: #D3D3D3; }\n #htfykocrmc .gt_col_headings { border-top-style: solid; border-top-width: 2px; border-top-color: black; border-bottom-style: solid; border-bottom-width: 0.25px; border-bottom-color: black; border-left-style: none; border-left-width: 1px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 1px; border-right-color: #D3D3D3; }\n #htfykocrmc .gt_col_heading { color: #333333; background-color: #FFFFFF; font-size: 16px; font-weight: normal; text-transform: inherit; border-left-style: none; border-left-width: 0px; border-left-color: white; border-right-style: none; border-right-width: 0px; border-right-color: white; vertical-align: bottom; padding-top: 2px; padding-bottom: 7px; padding-left: 5px; padding-right: 5px; overflow-x: hidden; }\n #htfykocrmc .gt_column_spanner_outer { color: #333333; background-color: #FFFFFF; font-size: 16px; font-weight: normal; text-transform: inherit; padding-top: 0; padding-bottom: 0; padding-left: 4px; padding-right: 4px; }\n #htfykocrmc .gt_column_spanner_outer:first-child { padding-left: 0; }\n #htfykocrmc .gt_column_spanner_outer:last-child { padding-right: 0; }\n #htfykocrmc .gt_column_spanner { border-bottom-style: solid; border-bottom-width: 0.25px; border-bottom-color: black; vertical-align: bottom; padding-top: 2px; padding-bottom: 2px; overflow-x: hidden; display: inline-block; width: 100%; }\n #htfykocrmc .gt_spanner_row { border-bottom-style: hidden; }\n #htfykocrmc .gt_group_heading { padding-top: 0px; padding-bottom: 0px; padding-left: 5px; padding-right: 5px; color: #333333; background-color: #FFFFFF; font-size: 0px; font-weight: initial; text-transform: inherit; border-top-style: solid; border-top-width: 0.25px; border-top-color: black; border-bottom-style: solid; border-bottom-width: 0.25px; border-bottom-color: black; border-left-style: none; border-left-width: 1px; border-left-color: white; border-right-style: none; border-right-width: 1px; border-right-color: white; vertical-align: middle; text-align: left; }\n #htfykocrmc .gt_empty_group_heading { padding: 0.5px; color: #333333; background-color: #FFFFFF; font-size: 0px; font-weight: initial; border-top-style: solid; border-top-width: 0.25px; border-top-color: black; border-bottom-style: solid; border-bottom-width: 0.25px; border-bottom-color: black; vertical-align: middle; }\n #htfykocrmc .gt_from_md> :first-child { margin-top: 0; }\n #htfykocrmc .gt_from_md> :last-child { margin-bottom: 0; }\n #htfykocrmc .gt_row { padding-top: 2px; padding-bottom: 2px; padding-left: 5px; padding-right: 5px; margin: 10px; border-top-style: none; border-top-width: 1px; border-top-color: #D3D3D3; border-left-style: none; border-left-width: 0px; border-left-color: white; border-right-style: none; border-right-width: 0px; border-right-color: white; vertical-align: middle; overflow-x: hidden; }\n #htfykocrmc .gt_stub { color: #333333; background-color: #FFFFFF; font-size: 16px; font-weight: initial; text-transform: inherit; border-right-style: hidden; border-right-width: 2px; border-right-color: #D3D3D3; padding-left: 5px; padding-right: 5px; }\n #htfykocrmc .gt_stub_row_group { color: #333333; background-color: #FFFFFF; font-size: 100%; font-weight: initial; text-transform: inherit; border-right-style: solid; border-right-width: 2px; border-right-color: #D3D3D3; padding-left: 5px; padding-right: 5px; vertical-align: top; }\n #htfykocrmc .gt_row_group_first td { border-top-width: 0.25px; }\n #htfykocrmc .gt_row_group_first th { border-top-width: 0.25px; }\n #htfykocrmc .gt_striped { color: #333333; background-color: #F4F4F4; }\n #htfykocrmc .gt_table_body { border-top-style: solid; border-top-width: 0px; border-top-color: black; border-bottom-style: solid; border-bottom-width: 2px; border-bottom-color: black; }\n #htfykocrmc .gt_grand_summary_row { color: #333333; background-color: #FFFFFF; text-transform: inherit; padding-top: 8px; padding-bottom: 8px; padding-left: 5px; padding-right: 5px; }\n #htfykocrmc .gt_first_grand_summary_row_bottom { border-top-style: double; border-top-width: 6px; border-top-color: #D3D3D3; }\n #htfykocrmc .gt_last_grand_summary_row_top { border-bottom-style: double; border-bottom-width: 6px; border-bottom-color: #D3D3D3; }\n #htfykocrmc .gt_sourcenotes { color: #333333; background-color: #FFFFFF; border-bottom-style: none; border-bottom-width: 2px; border-bottom-color: #D3D3D3; border-left-style: none; border-left-width: 2px; border-left-color: #D3D3D3; border-right-style: none; border-right-width: 2px; border-right-color: #D3D3D3; }\n #htfykocrmc .gt_sourcenote { font-size: 10px; padding-top: 4px; padding-bottom: 4px; padding-left: 5px; padding-right: 5px; text-align: left; }\n #htfykocrmc .gt_left { text-align: left; }\n #htfykocrmc .gt_center { text-align: center; }\n #htfykocrmc .gt_right { text-align: right; font-variant-numeric: tabular-nums; }\n #htfykocrmc .gt_font_normal { font-weight: normal; }\n #htfykocrmc .gt_font_bold { font-weight: bold; }\n #htfykocrmc .gt_font_italic { font-style: italic; }\n #htfykocrmc .gt_super { font-size: 65%; }\n #htfykocrmc .gt_footnote_marks { font-size: 75%; vertical-align: 0.4em; position: initial; }\n #htfykocrmc .gt_asterisk { font-size: 100%; vertical-align: 0; }\n \n</style>\n<table class=\"gt_table\" data-quarto-disable-processing=\"false\" data-quarto-bootstrap=\"false\">\n<thead>\n\n<tr class=\"gt_col_headings gt_spanner_row\">\n  <th class=\"gt_col_heading gt_columns_bottom_border gt_left\" rowspan=\"2\" colspan=\"1\" scope=\"col\" id=\"\"></th>\n  <th class=\"gt_center gt_columns_top_border gt_column_spanner_outer\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"minutes_watched\">\n    <span class=\"gt_column_spanner\">minutes_watched</span>\n  </th>\n  <th class=\"gt_center gt_columns_top_border gt_column_spanner_outer\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"minutes_post\">\n    <span class=\"gt_column_spanner\">minutes_post</span>\n  </th>\n  <th class=\"gt_center gt_columns_top_border gt_column_spanner_outer\" rowspan=\"1\" colspan=\"2\" scope=\"colgroup\" id=\"minutes_watched\">\n    <span class=\"gt_column_spanner\">minutes_watched</span>\n  </th>\n</tr>\n<tr class=\"gt_col_headings\">\n  <th class=\"gt_col_heading gt_columns_bottom_border gt_center\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"0\">(1)</th>\n  <th class=\"gt_col_heading gt_columns_bottom_border gt_center\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"1\">(2)</th>\n  <th class=\"gt_col_heading gt_columns_bottom_border gt_center\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"2\">(3)</th>\n  <th class=\"gt_col_heading gt_columns_bottom_border gt_center\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"3\">(4)</th>\n</tr>\n</thead>\n<tbody class=\"gt_table_body\">\n  <tr class=\"gt_group_heading_row\">\n    <th class=\"gt_group_heading\" colspan=\"5\">coef</th>\n  </tr>\n  <tr>\n    <th class=\"gt_row gt_left gt_stub\">treat</th>\n    <td class=\"gt_row gt_center\">0.7615*** <br> (0.2092)</td>\n    <td class=\"gt_row gt_center\">0.1918*** <br> (0.0288)</td>\n    <td class=\"gt_row gt_center\">0.1913*** <br> (0.0118)</td>\n    <td class=\"gt_row gt_center\">0.1913*** <br> (0.0287)</td>\n  </tr>\n  <tr>\n    <th class=\"gt_row gt_left gt_stub\">minutes_pre_c</th>\n    <td class=\"gt_row gt_center\"></td>\n    <td class=\"gt_row gt_center\">0.9992*** <br> (0.0001)</td>\n    <td class=\"gt_row gt_center\"></td>\n    <td class=\"gt_row gt_center\"></td>\n  </tr>\n  <tr>\n    <th class=\"gt_row gt_left gt_stub\">Intercept</th>\n    <td class=\"gt_row gt_center\">0.3574*** <br> (0.0148)</td>\n    <td class=\"gt_row gt_center\">0.3602*** <br> (0.0021)</td>\n    <td class=\"gt_row gt_center\"></td>\n    <td class=\"gt_row gt_center\"></td>\n  </tr>\n  <tr class=\"gt_group_heading_row\">\n    <th class=\"gt_group_heading\" colspan=\"5\">fe</th>\n  </tr>\n  <tr>\n    <th class=\"gt_row gt_left gt_stub\">day</th>\n    <td class=\"gt_row gt_center\">-</td>\n    <td class=\"gt_row gt_center\">-</td>\n    <td class=\"gt_row gt_center\">x</td>\n    <td class=\"gt_row gt_center\">x</td>\n  </tr>\n  <tr>\n    <th class=\"gt_row gt_left gt_stub\">user</th>\n    <td class=\"gt_row gt_center\">-</td>\n    <td class=\"gt_row gt_center\">-</td>\n    <td class=\"gt_row gt_center\">x</td>\n    <td class=\"gt_row gt_center\">x</td>\n  </tr>\n  <tr class=\"gt_group_heading_row\">\n    <th class=\"gt_group_heading\" colspan=\"5\">stats</th>\n  </tr>\n  <tr>\n    <th class=\"gt_row gt_left gt_stub\">Observations</th>\n    <td class=\"gt_row gt_center\">1,500,000</td>\n    <td class=\"gt_row gt_center\">100,000</td>\n    <td class=\"gt_row gt_center\">3,000,000</td>\n    <td class=\"gt_row gt_center\">3,000,000</td>\n  </tr>\n  <tr>\n    <th class=\"gt_row gt_left gt_stub\">R<sup>2</sup></th>\n    <td class=\"gt_row gt_center\">0.000009</td>\n    <td class=\"gt_row gt_center\">0.999</td>\n    <td class=\"gt_row gt_center\">0.999</td>\n    <td class=\"gt_row gt_center\">0.999</td>\n  </tr>\n</tbody>\n  <tfoot class=\"gt_sourcenotes\">\n  \n  <tr>\n    <td class=\"gt_sourcenote\" colspan=\"5\">Significance levels: * p &lt; 0.05, ** p &lt; 0.01, *** p &lt; 0.001. Format of coefficient cell: Coefficient   (Std. Error)</td>\n  </tr>\n\n</tfoot>\n\n</table>\n\n</div>\n        \n```\n:::\n:::\n\n\nThe panel errors produces point estimates and standard errors for the treatment variable that are very close to CUPED.\n\nThe sceptical reader might now object that this is all far from overwhelming evidence. After all , we fit each model only once! So it might well be\nthat we were just lucky and our results are driven by sampling error. In the next section, we will argue that this is not the case by means of a monte carlo simulation.\n\n### Digression: Heterogeneous Effects over Time via Panel Estimators\n\nOne example of the panel estimator is that it allows us to track treatment effects over time. This allows us to track novelty effects where in the beginning,\nusers interact a lot with a new feature, i.e. they spend a lot of time playing a gamee, but over time lose interest.\n\n::: {#9841f98e .cell execution_count=13}\n``` {.python .cell-code}\nfit_panel_time = pf.feols(\n    \"minutes_watched ~ i(day, ever_treated, ref = 14) | user + day\",\n    vcov={\"CRV1\": \"user\"},\n    data=data,\n    demeaner_backend=\"rust\",\n)\nfit_panel_time.iplot(\n    coord_flip=False,\n    plot_backend=\"matplotlib\",\n    cat_template=\"{value}\",\n    title=\"Event Study Plot\",\n)\n```\n\n::: {.cell-output .cell-output-display execution_count=13}\n![](panel_variance_reduction_files/figure-html/cell-14-output-1.png){width=949 height=564}\n:::\n:::\n\n\nInitially, we observe a large treatment effect that reverts to a null effect on day 23: a clear novelty effect pattern. Clearly, we should not accept this\nexperiment as it only adds technical complexity, but has no impact on user behavior beyond the initial effect. When ignoring time heterogeneity (as with the difference in means, cuped, and ATE panel estimators above), we completely miss that the effect fades out. With a dynamic panel estimator, we get it almost for free.\n\nFor more examples, see the paper by [Lal et al](https://arxiv.org/abs/2410.09952), which also shows how to estimate very large panel models in [SQL/duckdb](https://github.com/py-econometrics/duckreg) (yep, that's not a joke!).\n\n## Monte Carlo Simulation\n\nTo rule out that the examples above were purely do to look, we simply repeat them a couple of times using a monte carlo simulation.\n\n::: {#79f1aa03 .cell execution_count=14}\n``` {.python .cell-code}\ndef _variance_monte_carlo(data):\n    fit_dim = _difference_in_means(data)\n    fit_cuped, _ = _regression_cuped(data)\n    fit_panel = pf.feols(\n        \"minutes_watched ~ treat | user + day\",\n        data=data,\n        vcov={\"CRV1\": \"user\"},\n        demeaner_backend=\"rust\",\n    )\n\n    dim_se = fit_dim.tidy().xs(\"treat\")[\"Std. Error\"]\n    cuped_se = fit_cuped.tidy().xs(\"treat\")[\"Std. Error\"]\n    panel_se = fit_panel.tidy().xs(\"treat\")[\"Std. Error\"]\n\n    return dim_se, cuped_se, panel_se\n\n\ndef _run_simulation(N, sigma_unit, n_sim=100):\n    dim_se_arr = np.zeros(n_sim)\n    cuped_se_arr = np.zeros(n_sim)\n    panel_se_arr = np.zeros(n_sim)\n\n    for i in tqdm(range(n_sim)):\n        data = get_sharkfin(\n            num_units=N,\n            num_periods=30,\n            num_treated=int(N / 2),\n            treatment_start=15,\n            seed=i,\n            sigma_unit=sigma_unit,\n        )\n        data.rename(\n            columns={\"Y\": \"minutes_watched\", \"unit\": \"user\", \"year\": \"day\"},\n            inplace=True,\n        )\n\n        dim_se_arr[i], cuped_se_arr[i], panel_se_arr[i] = _variance_monte_carlo(data)\n\n    return pd.Series(\n        {\n            \"Difference-in-Means\": np.mean(dim_se_arr),\n            \"Cuped\": np.mean(cuped_se_arr),\n            \"Panel\": np.mean(panel_se_arr),\n        }\n    )\n```\n:::\n\n\n::: {#c8decf95 .cell execution_count=15}\n``` {.python .cell-code}\n# note that in a proper scientific simulation, we might want to set the\n# number of iterations to be much higher than 10\nse_sim_18 = _run_simulation(N=100_000, sigma_unit=18, n_sim=20)\ndisplay(se_sim_18)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n\r  0%|          | 0/20 [00:00<?, ?it/s]\r  5%|         | 1/20 [00:01<00:27,  1.44s/it]\r 10%|         | 2/20 [00:02<00:26,  1.47s/it]\r 15%|        | 3/20 [00:04<00:23,  1.41s/it]\r 20%|        | 4/20 [00:05<00:21,  1.37s/it]\r 25%|       | 5/20 [00:06<00:20,  1.35s/it]\r 30%|       | 6/20 [00:08<00:19,  1.40s/it]\r 35%|      | 7/20 [00:09<00:17,  1.38s/it]\r 40%|      | 8/20 [00:11<00:16,  1.37s/it]\r 45%|     | 9/20 [00:12<00:14,  1.36s/it]\r 50%|     | 10/20 [00:13<00:14,  1.40s/it]\r 55%|    | 11/20 [00:15<00:12,  1.41s/it]\r 60%|    | 12/20 [00:16<00:11,  1.38s/it]\r 65%|   | 13/20 [00:17<00:09,  1.36s/it]\r 70%|   | 14/20 [00:19<00:08,  1.37s/it]\r 75%|  | 15/20 [00:20<00:06,  1.37s/it]\r 80%|  | 16/20 [00:22<00:05,  1.36s/it]\r 85%| | 17/20 [00:23<00:04,  1.33s/it]\r 90%| | 18/20 [00:24<00:02,  1.32s/it]\r 95%|| 19/20 [00:25<00:01,  1.31s/it]\r100%|| 20/20 [00:27<00:00,  1.30s/it]\r100%|| 20/20 [00:27<00:00,  1.36s/it]\n```\n:::\n\n::: {.cell-output .cell-output-display}\n```\nDifference-in-Means    0.029457\nCuped                  0.004184\nPanel                  0.004185\ndtype: float64\n```\n:::\n:::\n\n\nSo we manage to reduce our standard errors by around 6x! This is pretty fantastic news, as it implies that we can run our experiment on a much smaller sample, but still achieve the same level of power! This is what we want to verify in the last step.\n\n## Power Simulation\n\nIn all simulations, we conduct a two-sided t-test with size $\\alpha = 0.01$.\n\n::: {#d9f8e812 .cell execution_count=16}\n``` {.python .cell-code}\ndef _power(nobs, n_sim):\n    res_df = pd.DataFrame()\n\n    for N in nobs:\n        dim_reject_null_arr = np.zeros(n_sim)\n        cuped_reject_null_arr = np.zeros(n_sim)\n        panel_reject_null_arr = np.zeros(n_sim)\n\n        for i in tqdm(range(n_sim)):\n            data = get_sharkfin(\n                num_units=N,\n                num_periods=30,\n                num_treated=int(N / 2),\n                treatment_start=15,\n                seed=i,\n                sigma_unit=18,\n            )\n            data.rename(\n                columns={\"Y\": \"minutes_watched\", \"unit\": \"user\", \"year\": \"day\"},\n                inplace=True,\n            )\n\n            fit_dim = _difference_in_means(data)\n            fit_cuped, _ = _regression_cuped(data)\n            fit_panel = pf.feols(\n                \"minutes_watched ~ treat | user + day\", data=data, vcov={\"CRV1\": \"user\"}\n            )\n\n            dim_reject_null_arr[i] = fit_dim.pvalue().xs(\"treat\") < 0.01\n            cuped_reject_null_arr[i] = fit_cuped.pvalue().xs(\"treat\") < 0.01\n            panel_reject_null_arr[i] = fit_panel.pvalue().xs(\"treat\") < 0.01\n\n        dim_reject_null_mean = np.mean(dim_reject_null_arr)\n        cuped_reject_null_mean = np.mean(cuped_reject_null_arr)\n        panel_reject_null_mean = np.mean(panel_reject_null_arr)\n\n        res = pd.DataFrame(\n            {\n                \"N\": [N],\n                \"Difference-in-Means\": [dim_reject_null_mean],\n                \"Cuped\": [cuped_reject_null_mean],\n                \"Panel\": [panel_reject_null_mean],\n            }\n        )\n\n        res_df = pd.concat([res_df, res], axis=0, ignore_index=True)\n\n    return res_df\n```\n:::\n\n\n::: {#f14f06d0 .cell execution_count=17}\n``` {.python .cell-code}\n# TODO: set n_sim higher\npower_df = _power(nobs=[100, 500, 1000, 5_000, 10_000, 100_000], n_sim=10)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n\r  0%|          | 0/10 [00:00<?, ?it/s]OMP: Info #276: omp_set_nested routine deprecated, please use omp_set_max_active_levels instead.\n\r 10%|         | 1/10 [00:03<00:31,  3.53s/it]\r 20%|        | 2/10 [00:03<00:12,  1.56s/it]\r 30%|       | 3/10 [00:03<00:06,  1.08it/s]\r 40%|      | 4/10 [00:04<00:03,  1.56it/s]\r 50%|     | 5/10 [00:04<00:02,  2.08it/s]\r 60%|    | 6/10 [00:04<00:01,  2.60it/s]\r 70%|   | 7/10 [00:04<00:00,  3.08it/s]\r 80%|  | 8/10 [00:04<00:00,  3.51it/s]\r 90%| | 9/10 [00:05<00:00,  3.87it/s]\r100%|| 10/10 [00:05<00:00,  4.15it/s]\r100%|| 10/10 [00:05<00:00,  1.89it/s]\n\r  0%|          | 0/10 [00:00<?, ?it/s]\r 10%|         | 1/10 [00:00<00:01,  4.86it/s]\r 20%|        | 2/10 [00:00<00:01,  4.90it/s]\r 30%|       | 3/10 [00:00<00:01,  4.88it/s]\r 40%|      | 4/10 [00:00<00:01,  4.87it/s]\r 50%|     | 5/10 [00:01<00:01,  4.86it/s]\r 60%|    | 6/10 [00:01<00:00,  4.87it/s]\r 70%|   | 7/10 [00:01<00:00,  4.85it/s]\r 80%|  | 8/10 [00:01<00:00,  4.87it/s]\r 90%| | 9/10 [00:01<00:00,  4.87it/s]\r100%|| 10/10 [00:02<00:00,  4.87it/s]\r100%|| 10/10 [00:02<00:00,  4.87it/s]\n\r  0%|          | 0/10 [00:00<?, ?it/s]\r 10%|         | 1/10 [00:00<00:01,  4.79it/s]\r 20%|        | 2/10 [00:00<00:01,  4.82it/s]\r 30%|       | 3/10 [00:00<00:01,  4.83it/s]\r 40%|      | 4/10 [00:00<00:01,  4.82it/s]\r 50%|     | 5/10 [00:01<00:01,  4.82it/s]\r 60%|    | 6/10 [00:01<00:00,  4.80it/s]\r 70%|   | 7/10 [00:01<00:00,  4.82it/s]\r 80%|  | 8/10 [00:01<00:00,  4.81it/s]\r 90%| | 9/10 [00:01<00:00,  4.80it/s]\r100%|| 10/10 [00:02<00:00,  4.80it/s]\r100%|| 10/10 [00:02<00:00,  4.81it/s]\n\r  0%|          | 0/10 [00:00<?, ?it/s]\r 10%|         | 1/10 [00:00<00:02,  4.06it/s]\r 20%|        | 2/10 [00:00<00:01,  4.07it/s]\r 30%|       | 3/10 [00:00<00:01,  4.07it/s]\r 40%|      | 4/10 [00:00<00:01,  4.07it/s]\r 50%|     | 5/10 [00:01<00:01,  4.06it/s]\r 60%|    | 6/10 [00:01<00:00,  4.05it/s]\r 70%|   | 7/10 [00:01<00:00,  4.03it/s]\r 80%|  | 8/10 [00:01<00:00,  4.02it/s]\r 90%| | 9/10 [00:02<00:00,  4.03it/s]\r100%|| 10/10 [00:02<00:00,  4.05it/s]\r100%|| 10/10 [00:02<00:00,  4.05it/s]\n\r  0%|          | 0/10 [00:00<?, ?it/s]\r 10%|         | 1/10 [00:00<00:02,  3.29it/s]\r 20%|        | 2/10 [00:00<00:02,  3.16it/s]\r 30%|       | 3/10 [00:00<00:02,  3.23it/s]\r 40%|      | 4/10 [00:01<00:01,  3.28it/s]\r 50%|     | 5/10 [00:01<00:01,  3.32it/s]\r 60%|    | 6/10 [00:01<00:01,  3.34it/s]\r 70%|   | 7/10 [00:02<00:00,  3.32it/s]\r 80%|  | 8/10 [00:02<00:00,  3.32it/s]\r 90%| | 9/10 [00:02<00:00,  3.31it/s]\r100%|| 10/10 [00:03<00:00,  3.32it/s]\r100%|| 10/10 [00:03<00:00,  3.30it/s]\n\r  0%|          | 0/10 [00:00<?, ?it/s]\r 10%|         | 1/10 [00:01<00:14,  1.59s/it]\r 20%|        | 2/10 [00:03<00:13,  1.69s/it]\r 30%|       | 3/10 [00:04<00:11,  1.66s/it]\r 40%|      | 4/10 [00:06<00:09,  1.66s/it]\r 50%|     | 5/10 [00:08<00:08,  1.63s/it]\r 60%|    | 6/10 [00:09<00:06,  1.62s/it]\r 70%|   | 7/10 [00:11<00:04,  1.61s/it]\r 80%|  | 8/10 [00:12<00:03,  1.59s/it]\r 90%| | 9/10 [00:14<00:01,  1.56s/it]\r100%|| 10/10 [00:15<00:00,  1.56s/it]\r100%|| 10/10 [00:15<00:00,  1.60s/it]\n```\n:::\n:::\n\n\n::: {#f1d5c1a8 .cell execution_count=18}\n``` {.python .cell-code}\ndisplay(power_df)\n```\n\n::: {.cell-output .cell-output-display}\n```{=html}\n<div>\n<style scoped>\n    .dataframe tbody tr th:only-of-type {\n        vertical-align: middle;\n    }\n\n    .dataframe tbody tr th {\n        vertical-align: top;\n    }\n\n    .dataframe thead th {\n        text-align: right;\n    }\n</style>\n<table border=\"1\" class=\"dataframe\">\n  <thead>\n    <tr style=\"text-align: right;\">\n      <th></th>\n      <th>N</th>\n      <th>Difference-in-Means</th>\n      <th>Cuped</th>\n      <th>Panel</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <th>0</th>\n      <td>100</td>\n      <td>0.5</td>\n      <td>0.1</td>\n      <td>0.1</td>\n    </tr>\n    <tr>\n      <th>1</th>\n      <td>500</td>\n      <td>0.4</td>\n      <td>0.9</td>\n      <td>0.9</td>\n    </tr>\n    <tr>\n      <th>2</th>\n      <td>1000</td>\n      <td>0.7</td>\n      <td>1.0</td>\n      <td>1.0</td>\n    </tr>\n    <tr>\n      <th>3</th>\n      <td>5000</td>\n      <td>0.5</td>\n      <td>1.0</td>\n      <td>1.0</td>\n    </tr>\n    <tr>\n      <th>4</th>\n      <td>10000</td>\n      <td>0.6</td>\n      <td>1.0</td>\n      <td>1.0</td>\n    </tr>\n    <tr>\n      <th>5</th>\n      <td>100000</td>\n      <td>0.9</td>\n      <td>1.0</td>\n      <td>1.0</td>\n    </tr>\n  </tbody>\n</table>\n</div>\n```\n:::\n:::\n\n\nCUPED and the panel estimator achieve 90% power with 500 observations, while the difference in means-estimator requires a sample that is orders of magnitude larger.\nTo conclude, we should mention that these effects stem from a stylized exmaple data set - in practice, the gains from CUPED / panel methods for variance reduction are much lower -\ncompanies with access to high quality panel data report reductions of 10% to 50% (see e.g. this paper by [Microsoft Bing](https://exp-platform.com/Documents/2013-02-CUPED-ImprovingSensitivityOfControlledExperiments.pdf)).\n\n## When does CUPED not work?\n\nCUPED only works when we explain a lot of \"residual\" variation, which in our example data set is controlled by the `sigma_unit` parameter. Let's see what happens if we drastically reduce it - we now change the parameter from `18` to `4`.\n\nWe repeat the standard error monte carlo simulation, but set `sigma_unit = 4`.\n\n::: {#806b59b2 .cell execution_count=19}\n``` {.python .cell-code}\nse_sim_1 = _run_simulation(N=100_000, sigma_unit=4, n_sim=10)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n\r  0%|          | 0/10 [00:00<?, ?it/s]\r 10%|         | 1/10 [00:01<00:12,  1.42s/it]\r 20%|        | 2/10 [00:02<00:11,  1.38s/it]\r 30%|       | 3/10 [00:04<00:09,  1.37s/it]\r 40%|      | 4/10 [00:05<00:08,  1.36s/it]\r 50%|     | 5/10 [00:06<00:06,  1.35s/it]\r 60%|    | 6/10 [00:08<00:05,  1.35s/it]\r 70%|   | 7/10 [00:09<00:04,  1.35s/it]\r 80%|  | 8/10 [00:10<00:02,  1.34s/it]\r 90%| | 9/10 [00:12<00:01,  1.34s/it]\r100%|| 10/10 [00:13<00:00,  1.35s/it]\r100%|| 10/10 [00:13<00:00,  1.35s/it]\n```\n:::\n:::\n\n\n::: {#5ad7c87f .cell execution_count=20}\n``` {.python .cell-code}\ndisplay(se_sim_1)\n```\n\n::: {.cell-output .cell-output-display}\n```\nDifference-in-Means    0.006852\nCuped                  0.004174\nPanel                  0.004186\ndtype: float64\n```\n:::\n:::\n\n\nAll of a sudden, the difference-in-means estimator has lower variance!\n\n::: {#9ba9cf6d .cell execution_count=21}\n``` {.python .cell-code}\ndisplay(se_sim_18)\n```\n\n::: {.cell-output .cell-output-display}\n```\nDifference-in-Means    0.029457\nCuped                  0.004184\nPanel                  0.004185\ndtype: float64\n```\n:::\n:::\n\n\nThe reason we do not achieve variance reduction this time is that the addition of pre-treatment covariates / unit fixed effects simply explains less unobserved variance than before.\n\n## Other useful links\n\n- [Matteo Courthoud's great blog post on CUPED](https://matteocourthoud.github.io/post/cuped/), goes through some theory, compares CUPED with other estimators, runs simulations studies, and summarizes the literature.\n- [Lal et al on panel experiments](https://arxiv.org/abs/2410.09952) explains why using panel estimators might be a good idea when analysing AB tests, and shows how it can be done efficiently in SQL.\n\n",
    "supporting": [
      "panel_variance_reduction_files/figure-html"
    ],
    "filters": [],
    "includes": {
      "include-in-header": [
        "<script src=\"https://cdn.jsdelivr.net/npm/requirejs@2.3.6/require.min.js\" integrity=\"sha384-c9c+LnTbwQ3aujuU7ULEPVvgLs+Fn6fJUvIGTsuu1ZcCf11fiEubah0ttpca4ntM sha384-6V1/AdqZRWk1KAlWbKBlGhN7VG4iE/yAZcO6NZPMF8od0vukrvr0tg4qY6NSrItx\" crossorigin=\"anonymous\"></script>\n<script src=\"https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js\" integrity=\"sha384-ZvpUoO/+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn/6Z/hRTt8+pR6L4N2\" crossorigin=\"anonymous\" data-relocate-top=\"true\"></script>\n<script type=\"application/javascript\">define('jquery', [],function() {return window.jQuery;})</script>\n"
      ]
    }
  }
}