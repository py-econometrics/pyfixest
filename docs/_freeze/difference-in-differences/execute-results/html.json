{
  "hash": "c9db75fa0437a37d43d615a56d3bd807",
  "result": {
    "engine": "jupyter",
    "markdown": "---\ntitle: Difference-in-Differences Estimation\nformat:\n  html:\n    html-table-processing: none\ntoc: true\ntoc-title: \"On this page\"\ntoc-location: left\nfreeze: auto\n---\n\n`PyFixest` supports event study designs via the canonical two-way fixed effects design, the 2-Step imputation estimator, and local projections.\n\nSee also [NBER SI methods lectures on Linear Panel Event Studies](https://www.nber.org/conferences/si-2023-methods-lectures-linear-panel-event-studies).\n\n## Setup\n\n::: {#041199ea .cell execution_count=1}\n``` {.python .cell-code}\nfrom importlib import resources\n\nimport pandas as pd\n\nimport pyfixest as pf\nfrom pyfixest.report.utils import rename_event_study_coefs\nfrom pyfixest.utils.dgps import get_sharkfin\n\n%load_ext watermark\n%watermark --iversions\n%load_ext autoreload\n%autoreload 2\n```\n\n::: {.cell-output .cell-output-display}\n```{=html}\n\n            <div id=\"4lJCSI\"></div>\n            <script type=\"text/javascript\" data-lets-plot-script=\"library\">\n                if(!window.letsPlotCallQueue) {\n                    window.letsPlotCallQueue = [];\n                }; \n                window.letsPlotCall = function(f) {\n                    window.letsPlotCallQueue.push(f);\n                };\n                (function() {\n                    var script = document.createElement(\"script\");\n                    script.type = \"text/javascript\";\n                    script.src = \"https://cdn.jsdelivr.net/gh/JetBrains/lets-plot@v4.7.3/js-package/distr/lets-plot.min.js\";\n                    script.onload = function() {\n                        window.letsPlotCall = function(f) {f();};\n                        window.letsPlotCallQueue.forEach(function(f) {f();});\n                        window.letsPlotCallQueue = [];\n                        \n                    };\n                    script.onerror = function(event) {\n                        window.letsPlotCall = function(f) {};    // noop\n                        window.letsPlotCallQueue = [];\n                        var div = document.createElement(\"div\");\n                        div.style.color = 'darkred';\n                        div.textContent = 'Error loading Lets-Plot JS';\n                        document.getElementById(\"4lJCSI\").appendChild(div);\n                    };\n                    var e = document.getElementById(\"4lJCSI\");\n                    e.appendChild(script);\n                })()\n            </script>\n            \n```\n:::\n\n::: {.cell-output .cell-output-display}\n```{=html}\n\n            <div id=\"vDD5Jb\"></div>\n            <script type=\"text/javascript\" data-lets-plot-script=\"library\">\n                if(!window.letsPlotCallQueue) {\n                    window.letsPlotCallQueue = [];\n                }; \n                window.letsPlotCall = function(f) {\n                    window.letsPlotCallQueue.push(f);\n                };\n                (function() {\n                    var script = document.createElement(\"script\");\n                    script.type = \"text/javascript\";\n                    script.src = \"https://cdn.jsdelivr.net/gh/JetBrains/lets-plot@v4.7.3/js-package/distr/lets-plot.min.js\";\n                    script.onload = function() {\n                        window.letsPlotCall = function(f) {f();};\n                        window.letsPlotCallQueue.forEach(function(f) {f();});\n                        window.letsPlotCallQueue = [];\n                        \n                    };\n                    script.onerror = function(event) {\n                        window.letsPlotCall = function(f) {};    // noop\n                        window.letsPlotCallQueue = [];\n                        var div = document.createElement(\"div\");\n                        div.style.color = 'darkred';\n                        div.textContent = 'Error loading Lets-Plot JS';\n                        document.getElementById(\"vDD5Jb\").appendChild(div);\n                    };\n                    var e = document.getElementById(\"vDD5Jb\");\n                    e.appendChild(script);\n                })()\n            </script>\n            \n```\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\npandas  : 2.3.3\npyfixest: 0.40.1\n\n```\n:::\n:::\n\n\n::: {#ac63c1c9 .cell execution_count=2}\n``` {.python .cell-code}\n# one-shot adoption data - parallel trends is true\ndf_one_cohort = get_sharkfin()\ndf_one_cohort.head()\n```\n\n::: {.cell-output .cell-output-display execution_count=2}\n```{=html}\n<div>\n<style scoped>\n    .dataframe tbody tr th:only-of-type {\n        vertical-align: middle;\n    }\n\n    .dataframe tbody tr th {\n        vertical-align: top;\n    }\n\n    .dataframe thead th {\n        text-align: right;\n    }\n</style>\n<table border=\"1\" class=\"dataframe\">\n  <thead>\n    <tr style=\"text-align: right;\">\n      <th></th>\n      <th>unit</th>\n      <th>year</th>\n      <th>treat</th>\n      <th>Y</th>\n      <th>ever_treated</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <th>0</th>\n      <td>0</td>\n      <td>0</td>\n      <td>0</td>\n      <td>1.629307</td>\n      <td>0</td>\n    </tr>\n    <tr>\n      <th>1</th>\n      <td>0</td>\n      <td>1</td>\n      <td>0</td>\n      <td>0.825902</td>\n      <td>0</td>\n    </tr>\n    <tr>\n      <th>2</th>\n      <td>0</td>\n      <td>2</td>\n      <td>0</td>\n      <td>0.208988</td>\n      <td>0</td>\n    </tr>\n    <tr>\n      <th>3</th>\n      <td>0</td>\n      <td>3</td>\n      <td>0</td>\n      <td>-0.244739</td>\n      <td>0</td>\n    </tr>\n    <tr>\n      <th>4</th>\n      <td>0</td>\n      <td>4</td>\n      <td>0</td>\n      <td>0.804665</td>\n      <td>0</td>\n    </tr>\n  </tbody>\n</table>\n</div>\n```\n:::\n:::\n\n\n::: {#9f734d19 .cell execution_count=3}\n``` {.python .cell-code}\n# multi-cohort adoption data\ndf_multi_cohort = pd.read_csv(\n    resources.files(\"pyfixest.did.data\").joinpath(\"df_het.csv\")\n)\ndf_multi_cohort.head()\n```\n\n::: {.cell-output .cell-output-display execution_count=3}\n```{=html}\n<div>\n<style scoped>\n    .dataframe tbody tr th:only-of-type {\n        vertical-align: middle;\n    }\n\n    .dataframe tbody tr th {\n        vertical-align: top;\n    }\n\n    .dataframe thead th {\n        text-align: right;\n    }\n</style>\n<table border=\"1\" class=\"dataframe\">\n  <thead>\n    <tr style=\"text-align: right;\">\n      <th></th>\n      <th>unit</th>\n      <th>state</th>\n      <th>group</th>\n      <th>unit_fe</th>\n      <th>g</th>\n      <th>year</th>\n      <th>year_fe</th>\n      <th>treat</th>\n      <th>rel_year</th>\n      <th>rel_year_binned</th>\n      <th>error</th>\n      <th>te</th>\n      <th>te_dynamic</th>\n      <th>dep_var</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <th>0</th>\n      <td>1</td>\n      <td>33</td>\n      <td>Group 2</td>\n      <td>7.043016</td>\n      <td>2010</td>\n      <td>1990</td>\n      <td>0.066159</td>\n      <td>False</td>\n      <td>-20.0</td>\n      <td>-6</td>\n      <td>-0.086466</td>\n      <td>0</td>\n      <td>0.0</td>\n      <td>7.022709</td>\n    </tr>\n    <tr>\n      <th>1</th>\n      <td>1</td>\n      <td>33</td>\n      <td>Group 2</td>\n      <td>7.043016</td>\n      <td>2010</td>\n      <td>1991</td>\n      <td>-0.030980</td>\n      <td>False</td>\n      <td>-19.0</td>\n      <td>-6</td>\n      <td>0.766593</td>\n      <td>0</td>\n      <td>0.0</td>\n      <td>7.778628</td>\n    </tr>\n    <tr>\n      <th>2</th>\n      <td>1</td>\n      <td>33</td>\n      <td>Group 2</td>\n      <td>7.043016</td>\n      <td>2010</td>\n      <td>1992</td>\n      <td>-0.119607</td>\n      <td>False</td>\n      <td>-18.0</td>\n      <td>-6</td>\n      <td>1.512968</td>\n      <td>0</td>\n      <td>0.0</td>\n      <td>8.436377</td>\n    </tr>\n    <tr>\n      <th>3</th>\n      <td>1</td>\n      <td>33</td>\n      <td>Group 2</td>\n      <td>7.043016</td>\n      <td>2010</td>\n      <td>1993</td>\n      <td>0.126321</td>\n      <td>False</td>\n      <td>-17.0</td>\n      <td>-6</td>\n      <td>0.021870</td>\n      <td>0</td>\n      <td>0.0</td>\n      <td>7.191207</td>\n    </tr>\n    <tr>\n      <th>4</th>\n      <td>1</td>\n      <td>33</td>\n      <td>Group 2</td>\n      <td>7.043016</td>\n      <td>2010</td>\n      <td>1994</td>\n      <td>-0.106921</td>\n      <td>False</td>\n      <td>-16.0</td>\n      <td>-6</td>\n      <td>-0.017603</td>\n      <td>0</td>\n      <td>0.0</td>\n      <td>6.918492</td>\n    </tr>\n  </tbody>\n</table>\n</div>\n```\n:::\n:::\n\n\n## Examining Treatment Timing\n\nBefore any DiD estimation, we need to examine the treatment timing, since it is crucial to our choice of estimator.\n\n::: {#834768f0 .cell execution_count=4}\n``` {.python .cell-code}\npf.panelview(\n    df_one_cohort,\n    unit=\"unit\",\n    time=\"year\",\n    treat=\"treat\",\n    collapse_to_cohort=True,\n    sort_by_timing=True,\n    ylab=\"Cohort\",\n    xlab=\"Year\",\n    title=\"Treatment Assignment Cohorts\",\n    figsize=(6, 5),\n)\n```\n\n::: {.cell-output .cell-output-display}\n![](difference-in-differences_files/figure-html/cell-5-output-1.png){width=502 height=454}\n:::\n:::\n\n\n::: {#215a5d69 .cell execution_count=5}\n``` {.python .cell-code}\npf.panelview(\n    df_multi_cohort,\n    unit=\"unit\",\n    time=\"year\",\n    treat=\"treat\",\n    collapse_to_cohort=True,\n    sort_by_timing=True,\n    ylab=\"Cohort\",\n    xlab=\"Year\",\n    title=\"Treatment Assignment Cohorts\",\n    figsize=(6, 5),\n)\n```\n\n::: {.cell-output .cell-output-display}\n![](difference-in-differences_files/figure-html/cell-6-output-1.png){width=503 height=454}\n:::\n:::\n\n\nWe immediately see that we have staggered adoption of treatment in the second case, which implies that a naive application of 2WFE might yield biased estimates under substantial effect heterogeneity.\n\nWe can also plot treatment assignment in a disaggregated fashion, which gives us a sense of cohort sizes.\n\n::: {#aab72f32 .cell execution_count=6}\n``` {.python .cell-code}\npf.panelview(\n    df_multi_cohort,\n    unit=\"unit\",\n    time=\"year\",\n    treat=\"treat\",\n    sort_by_timing=True,\n    ylab=\"Unit\",\n    xlab=\"Year\",\n    title=\"Treatment Assignment (all units)\",\n    figsize=(6, 5),\n)\n```\n\n::: {.cell-output .cell-output-display}\n![](difference-in-differences_files/figure-html/cell-7-output-1.png){width=529 height=454}\n:::\n:::\n\n\n## Inspecting the Outcome Variable\n\n`pf.panelview()` further allows us to inspect the \"outcome\" variable over time:\n\n::: {#8bee3bae .cell fig-height='0.1' fig-width='0.4' execution_count=7}\n``` {.python .cell-code}\npf.panelview(\n    df_multi_cohort,\n    outcome=\"dep_var\",\n    unit=\"unit\",\n    time=\"year\",\n    treat=\"treat\",\n    collapse_to_cohort=True,\n    title=\"Outcome Plot\",\n    legend=True,\n    figsize=(7, 2.5),\n)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n/Users/afischer/Documents/pyfixest/pyfixest/did/visualize.py:197: FutureWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.\n  .apply(get_treatment_start)\n```\n:::\n\n::: {.cell-output .cell-output-display}\n![](difference-in-differences_files/figure-html/cell-8-output-2.png){width=576 height=282}\n:::\n:::\n\n\nWe immediately see that the first cohort is switched into treatment in 2000, while the second cohort is switched into treatment by 2010.\nBefore each cohort is switched into treatment, the trends are parallel.\n\nWe can additionally inspect individual units by dropping the collapse_to_cohort argument. Because we have a large sample, we might want to inspect only a subset\nof units.\n\n::: {#7fccc865 .cell fig-height='1' fig-width='4' execution_count=8}\n``` {.python .cell-code}\npf.panelview(\n    df_multi_cohort,\n    outcome=\"dep_var\",\n    unit=\"unit\",\n    time=\"year\",\n    treat=\"treat\",\n    subsamp=100,\n    title = \"Outcome Plot\",\n    legend=True,\n    figsize=(7, 2.5),\n)\n```\n\n::: {.cell-output .cell-output-display}\n![](difference-in-differences_files/figure-html/cell-9-output-1.png){width=587 height=282}\n:::\n:::\n\n\n## One-shot adoption: Static and Dynamic Specifications\n\nAfter taking a first look at the data, let's turn to estimation. We return to the `df_one_cohort` data set (without staggered treatment rollout).\n\n::: {#099ee7f1 .cell execution_count=9}\n``` {.python .cell-code}\nfit_static_twfe = pf.feols(\n    \"Y ~ treat | unit + year\",\n    df_one_cohort,\n    vcov={\"CRV1\": \"unit\"},\n)\nfit_static_twfe.summary()\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nOMP: Info #276: omp_set_nested routine deprecated, please use omp_set_max_active_levels instead.\n```\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\n###\n\nEstimation:  OLS\nDep. var.: Y, Fixed effects: unit + year\nInference:  CRV1\nObservations:  30000\n\n| Coefficient   |   Estimate |   Std. Error |   t value |   Pr(>|t|) |   2.5% |   97.5% |\n|:--------------|-----------:|-------------:|----------:|-----------:|-------:|--------:|\n| treat         |      0.206 |        0.052 |     3.927 |      0.000 |  0.103 |   0.308 |\n---\nRMSE: 0.701 R2: 0.905 R2 Within: 0.003 \n```\n:::\n:::\n\n\nSince this is a single-cohort dataset, this estimate is consistent for the ATT under parallel trends. We can estimate heterogeneous effects by time by interacting time with the treated group:\n\n::: {#80a9a7f4 .cell execution_count=10}\n``` {.python .cell-code}\nfit_dynamic_twfe = pf.feols(\n    \"Y ~ i(year, ever_treated,  ref = 14) | unit + year\",\n    df_one_cohort,\n    vcov={\"CRV1\": \"unit\"},\n)\n```\n:::\n\n\n::: {#625bcffd .cell execution_count=11}\n``` {.python .cell-code}\nfit_dynamic_twfe.iplot(\n    coord_flip=False,\n    title=\"Event Study\",\n    figsize=[1200, 400],\n    yintercept=0,\n    xintercept=13.5,\n    labels=rename_event_study_coefs(fit_dynamic_twfe._coefnames),\n)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n/var/folders/98/c353q4p95v5_fz62gr5c9td80000gn/T/ipykernel_15240/3569604189.py:7: DeprecationWarning: The function `_relabel_expvar` is deprecated as we have adjusted the naming of variables interacted via the i() operator with pyfixest 0.50. For regression tables, please rely on the `labels` and `cat_template` arguments of `pf.etable()` instead. \n  labels=rename_event_study_coefs(fit_dynamic_twfe._coefnames),\n```\n:::\n\n::: {.cell-output .cell-output-display execution_count=11}\n```{=html}\n   <div id=\"hOTujt\"></div>\n   <script type=\"text/javascript\" data-lets-plot-script=\"plot\">\n   \n   (function() {\n   // ----------\n   \n   const forceImmediateRender = false;\n   const responsive = false;\n   \n   let sizing = {\n       width_mode: \"MIN\",\n       height_mode: \"SCALED\",\n       width: null, \n       height: null \n   };\n   \n   const preferredWidth = document.body.dataset.letsPlotPreferredWidth;\n   if (preferredWidth !== undefined) {\n       sizing = {\n           width_mode: 'FIXED',\n           height_mode: 'SCALED',\n           width: parseFloat(preferredWidth)\n       };\n   }\n   \n   const containerDiv = document.getElementById(\"hOTujt\");\n   let fig = null;\n   \n   function renderPlot() {\n       if (fig === null) {\n           const plotSpec = {\n\"data\":{\n\"Coefficient\":[\"year::0:ever_treated\",\"year::1:ever_treated\",\"year::2:ever_treated\",\"year::3:ever_treated\",\"year::4:ever_treated\",\"year::5:ever_treated\",\"year::6:ever_treated\",\"year::7:ever_treated\",\"year::8:ever_treated\",\"year::9:ever_treated\",\"year::10:ever_treated\",\"year::11:ever_treated\",\"year::12:ever_treated\",\"year::13:ever_treated\",\"year::15:ever_treated\",\"year::16:ever_treated\",\"year::17:ever_treated\",\"year::18:ever_treated\",\"year::19:ever_treated\",\"year::20:ever_treated\",\"year::21:ever_treated\",\"year::22:ever_treated\",\"year::23:ever_treated\",\"year::24:ever_treated\",\"year::25:ever_treated\",\"year::26:ever_treated\",\"year::27:ever_treated\",\"year::28:ever_treated\",\"year::29:ever_treated\"],\n\"Estimate\":[-0.11793283974656142,-0.05873668086088776,-0.08000343580727418,-0.08379134398914258,-0.008748851140692224,0.005462239132209692,-0.03792992222408285,-0.047858895285599085,-0.04635988251882213,-0.13226806862443194,-0.18717489395203615,-0.08522349395857057,-0.043167595587726725,-0.02873607027764111,0.1373587547946926,0.3202363651170568,0.35905884723796727,0.46798125389692313,0.4382015784858732,0.41808368984607586,0.4400262834863111,0.44998930169725637,-0.08217326994918135,-0.11627011066492493,-0.13906483994322646,-0.16796427436573594,-0.1467561186906023,-0.12969798817452496,-0.11725958933841533],\n\"2.5%\":[-0.2646937839901558,-0.21544636873280976,-0.23981586709260283,-0.24592148277448506,-0.16741793715498826,-0.15657366276689025,-0.20237330351720398,-0.21300958471636788,-0.20669148807204774,-0.28417210141476024,-0.3238043269330341,-0.2099485227362348,-0.15409717460661623,-0.11056264387154215,0.057008975252615834,0.21463716944760447,0.2391081162035139,0.33982502387038716,0.3030291624102585,0.27828503291377715,0.2930538712475217,0.29968376424169435,-0.23793906288420313,-0.27354535803545277,-0.29912440202624146,-0.335869887028804,-0.3129969653284205,-0.2982050869771893,-0.28783945099742764],\n\"97.5%\":[0.028828104497032978,0.09797300701103423,0.07980899547805448,0.07833879479619989,0.14992023487360384,0.16749814103130964,0.1265134590690383,0.11729179414516971,0.11397172303440349,0.01963596416589633,-0.05054546097103818,0.03950153481909366,0.0677619834311628,0.05309050331625993,0.21770853433676934,0.4258355607865091,0.47900957827242063,0.5961374839234591,0.573373994561488,0.5578823467783746,0.5869986957251005,0.6002948391528184,0.07359252298584044,0.04100513670560291,0.020994722139788535,-5.866170266788373E-5,0.019484727947215896,0.038809110628139326,0.053320272320596954],\n\"Model\":[\"Y ~ i(year, ever_treated,  ref = 14) | unit + year\",\"Y ~ i(year, ever_treated,  ref = 14) | unit + year\",\"Y ~ i(year, ever_treated,  ref = 14) | unit + year\",\"Y ~ i(year, ever_treated,  ref = 14) | unit + year\",\"Y ~ i(year, ever_treated,  ref = 14) | unit + year\",\"Y ~ i(year, ever_treated,  ref = 14) | unit + year\",\"Y ~ i(year, ever_treated,  ref = 14) | unit + year\",\"Y ~ i(year, ever_treated,  ref = 14) | unit + year\",\"Y ~ i(year, ever_treated,  ref = 14) | unit + year\",\"Y ~ i(year, ever_treated,  ref = 14) | unit + year\",\"Y ~ i(year, ever_treated,  ref = 14) | unit + year\",\"Y ~ i(year, ever_treated,  ref = 14) | unit + year\",\"Y ~ i(year, ever_treated,  ref = 14) | unit + year\",\"Y ~ i(year, ever_treated,  ref = 14) | unit + year\",\"Y ~ i(year, ever_treated,  ref = 14) | unit + year\",\"Y ~ i(year, ever_treated,  ref = 14) | unit + year\",\"Y ~ i(year, ever_treated,  ref = 14) | unit + year\",\"Y ~ i(year, ever_treated,  ref = 14) | unit + year\",\"Y ~ i(year, ever_treated,  ref = 14) | unit + year\",\"Y ~ i(year, ever_treated,  ref = 14) | unit + year\",\"Y ~ i(year, ever_treated,  ref = 14) | unit + year\",\"Y ~ i(year, ever_treated,  ref = 14) | unit + year\",\"Y ~ i(year, ever_treated,  ref = 14) | unit + year\",\"Y ~ i(year, ever_treated,  ref = 14) | unit + year\",\"Y ~ i(year, ever_treated,  ref = 14) | unit + year\",\"Y ~ i(year, ever_treated,  ref = 14) | unit + year\",\"Y ~ i(year, ever_treated,  ref = 14) | unit + year\",\"Y ~ i(year, ever_treated,  ref = 14) | unit + year\",\"Y ~ i(year, ever_treated,  ref = 14) | unit + year\"]\n},\n\"mapping\":{\n\"x\":\"Coefficient\",\n\"y\":\"Estimate\",\n\"color\":\"Model\"\n},\n\"data_meta\":{\n\"series_annotations\":[{\n\"type\":\"int\",\n\"column\":\"level_0\"\n},{\n\"type\":\"int\",\n\"column\":\"index\"\n},{\n\"type\":\"str\",\n\"column\":\"Coefficient\"\n},{\n\"type\":\"float\",\n\"column\":\"Estimate\"\n},{\n\"type\":\"float\",\n\"column\":\"Std. Error\"\n},{\n\"type\":\"float\",\n\"column\":\"t value\"\n},{\n\"type\":\"float\",\n\"column\":\"Pr(>|t|)\"\n},{\n\"type\":\"float\",\n\"column\":\"2.5%\"\n},{\n\"type\":\"float\",\n\"column\":\"97.5%\"\n},{\n\"type\":\"str\",\n\"column\":\"Model\"\n}]\n},\n\"guides\":{\n\"y\":{\n\"title\":\"Estimate and 95.0% Confidence Interval\"\n}\n},\n\"ggsize\":{\n\"width\":1200.0,\n\"height\":400.0\n},\n\"theme\":{\n\"axis_text_x\":{\n\"angle\":0.0,\n\"blank\":false\n}\n},\n\"ggtitle\":{\n\"text\":\"Event Study\"\n},\n\"kind\":\"plot\",\n\"scales\":[],\n\"layers\":[{\n\"geom\":\"point\",\n\"mapping\":{\n},\n\"position\":{\n\"name\":\"dodge\",\n\"width\":0.5\n},\n\"data_meta\":{\n},\n\"data\":{\n}\n},{\n\"geom\":\"errorbar\",\n\"mapping\":{\n\"ymin\":\"2.5%\",\n\"ymax\":\"97.5%\"\n},\n\"position\":{\n\"name\":\"dodge\",\n\"width\":0.5\n},\n\"data_meta\":{\n},\n\"width\":0.05,\n\"data\":{\n}\n},{\n\"geom\":\"hline\",\n\"mapping\":{\n},\n\"data_meta\":{\n},\n\"yintercept\":0.0,\n\"linetype\":\"dashed\",\n\"color\":\"black\",\n\"data\":{\n}\n},{\n\"geom\":\"vline\",\n\"mapping\":{\n},\n\"data_meta\":{\n},\n\"xintercept\":13.5,\n\"linetype\":\"dashed\",\n\"color\":\"black\",\n\"data\":{\n}\n}],\n\"metainfo_list\":[],\n\"spec_id\":\"1\"\n};\n           window.letsPlotCall(function() { fig = LetsPlot.buildPlotFromProcessedSpecs(plotSpec, containerDiv, sizing); });\n       } else {\n           fig.updateView({});\n       }\n   }\n   \n   const renderImmediately = \n       forceImmediateRender || (\n           sizing.width_mode === 'FIXED' && \n           (sizing.height_mode === 'FIXED' || sizing.height_mode === 'SCALED')\n       );\n   \n   if (renderImmediately) {\n       renderPlot();\n   }\n   \n   if (!renderImmediately || responsive) {\n       // Set up observer for initial sizing or continuous monitoring\n       var observer = new ResizeObserver(function(entries) {\n           for (let entry of entries) {\n               if (entry.contentBoxSize && \n                   entry.contentBoxSize[0].inlineSize > 0) {\n                   if (!responsive && observer) {\n                       observer.disconnect();\n                       observer = null;\n                   }\n                   renderPlot();\n                   if (!responsive) {\n                       break;\n                   }\n               }\n           }\n       });\n       \n       observer.observe(containerDiv);\n   }\n   \n   // ----------\n   })();\n   \n   </script>\n```\n:::\n:::\n\n\nEvent study plots like this are very informative, as they allow us to visually inspect the parallel trends assumption and also the dynamic effects of the treatment.\n\nBased on a cursory glance, one would conclude that parallel trends does not hold because one of the pre-treatment coefficient has a confidence interval that does not include zero. However, we know that parallel trends is true because the treatment is randomly assigned in the underlying DGP.\n\n## Pointwise vs Simultaneous Inference in Event Studies\n\nThis is an example of a false positive in testing for pre-trends produced by _pointwise_ inference (where each element of the coefficient vector is tested separately).\n\nAs an alternative, we can use simultaneous confidence bands of the form $[a, b] = ([a_k, b_k])_{k=1}^K$ such that\n\n$$\nP(\\beta \\in [a, b]) = P(\\beta_k \\in [a_k, b_k] \\forall k) \\rightarrow 1 - \\alpha\n$$\n\nThese bands can be constructed by using a carefully chosen critical value $c$ that [accounts for the covariance between coefficients using the multiplier bootstrap](https://www.annualreviews.org/docserver/fulltext/statistics/10/1/annurev-statistics-040120-022239.pdf?expires=1724543273&id=id&accname=guest&checksum=0D11ADF816FFFA0AE21BD7EDC6DB1801#page=14). In pointwise inference, the critical value is $c = z_{1 - \\alpha/2} = 1.96$ for $\\alpha = 0.05$; the corresponding critical value for simultaneous inference is typically larger. These are also known as `sup-t` bands in the literature (see lec 3 of the NBER SI methods lectures linked above).\n\nThis is implemented in the `confint(joint=True)` method in the `feols` class. If we pass the `joint='both'` argument to `iplot`, we get the simultaneous confidence bands (for all event study coefficients) in addition to the pointwise confidence intervals. Note that simultaneous inference for all event study coefficients may be overly conservative, especially when the number of coefficients is large; one may instead choose to perform joint inference for [all pre-treatment coefficients and all post-treatment coefficients separately](https://gist.github.com/apoorvalal/8a7687d3620577fd5214f1d43fc740b3).\n\n::: {#35e76740 .cell execution_count=12}\n``` {.python .cell-code}\nfit_dynamic_twfe.iplot(\n    coord_flip=False,\n    title=\"Event Study\",\n    figsize=[1200, 400],\n    yintercept=0,\n    xintercept=13.5,\n    joint=\"both\",\n    labels=rename_event_study_coefs(fit_dynamic_twfe._coefnames),\n)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n/var/folders/98/c353q4p95v5_fz62gr5c9td80000gn/T/ipykernel_15240/3057495514.py:8: DeprecationWarning: The function `_relabel_expvar` is deprecated as we have adjusted the naming of variables interacted via the i() operator with pyfixest 0.50. For regression tables, please rely on the `labels` and `cat_template` arguments of `pf.etable()` instead. \n  labels=rename_event_study_coefs(fit_dynamic_twfe._coefnames),\n```\n:::\n\n::: {.cell-output .cell-output-display execution_count=12}\n```{=html}\n   <div id=\"dRHE5j\"></div>\n   <script type=\"text/javascript\" data-lets-plot-script=\"plot\">\n   \n   (function() {\n   // ----------\n   \n   const forceImmediateRender = false;\n   const responsive = false;\n   \n   let sizing = {\n       width_mode: \"MIN\",\n       height_mode: \"SCALED\",\n       width: null, \n       height: null \n   };\n   \n   const preferredWidth = document.body.dataset.letsPlotPreferredWidth;\n   if (preferredWidth !== undefined) {\n       sizing = {\n           width_mode: 'FIXED',\n           height_mode: 'SCALED',\n           width: parseFloat(preferredWidth)\n       };\n   }\n   \n   const containerDiv = document.getElementById(\"dRHE5j\");\n   let fig = null;\n   \n   function renderPlot() {\n       if (fig === null) {\n           const plotSpec = {\n\"data\":{\n\"Coefficient\":[\"year::0:ever_treated\",\"year::1:ever_treated\",\"year::2:ever_treated\",\"year::3:ever_treated\",\"year::4:ever_treated\",\"year::5:ever_treated\",\"year::6:ever_treated\",\"year::7:ever_treated\",\"year::8:ever_treated\",\"year::9:ever_treated\",\"year::10:ever_treated\",\"year::11:ever_treated\",\"year::12:ever_treated\",\"year::13:ever_treated\",\"year::15:ever_treated\",\"year::16:ever_treated\",\"year::17:ever_treated\",\"year::18:ever_treated\",\"year::19:ever_treated\",\"year::20:ever_treated\",\"year::21:ever_treated\",\"year::22:ever_treated\",\"year::23:ever_treated\",\"year::24:ever_treated\",\"year::25:ever_treated\",\"year::26:ever_treated\",\"year::27:ever_treated\",\"year::28:ever_treated\",\"year::29:ever_treated\",\"year::0:ever_treated\",\"year::1:ever_treated\",\"year::2:ever_treated\",\"year::3:ever_treated\",\"year::4:ever_treated\",\"year::5:ever_treated\",\"year::6:ever_treated\",\"year::7:ever_treated\",\"year::8:ever_treated\",\"year::9:ever_treated\",\"year::10:ever_treated\",\"year::11:ever_treated\",\"year::12:ever_treated\",\"year::13:ever_treated\",\"year::15:ever_treated\",\"year::16:ever_treated\",\"year::17:ever_treated\",\"year::18:ever_treated\",\"year::19:ever_treated\",\"year::20:ever_treated\",\"year::21:ever_treated\",\"year::22:ever_treated\",\"year::23:ever_treated\",\"year::24:ever_treated\",\"year::25:ever_treated\",\"year::26:ever_treated\",\"year::27:ever_treated\",\"year::28:ever_treated\",\"year::29:ever_treated\"],\n\"Estimate\":[-0.11793283974656142,-0.05873668086088776,-0.08000343580727418,-0.08379134398914258,-0.008748851140692224,0.005462239132209692,-0.03792992222408285,-0.047858895285599085,-0.04635988251882213,-0.13226806862443194,-0.18717489395203615,-0.08522349395857057,-0.043167595587726725,-0.02873607027764111,0.1373587547946926,0.3202363651170568,0.35905884723796727,0.46798125389692313,0.4382015784858732,0.41808368984607586,0.4400262834863111,0.44998930169725637,-0.08217326994918135,-0.11627011066492493,-0.13906483994322646,-0.16796427436573594,-0.1467561186906023,-0.12969798817452496,-0.11725958933841533,-0.11793283974656142,-0.05873668086088776,-0.08000343580727418,-0.08379134398914258,-0.008748851140692224,0.005462239132209692,-0.03792992222408285,-0.047858895285599085,-0.04635988251882213,-0.13226806862443194,-0.18717489395203615,-0.08522349395857057,-0.043167595587726725,-0.02873607027764111,0.1373587547946926,0.3202363651170568,0.35905884723796727,0.46798125389692313,0.4382015784858732,0.41808368984607586,0.4400262834863111,0.44998930169725637,-0.08217326994918135,-0.11627011066492493,-0.13906483994322646,-0.16796427436573594,-0.1467561186906023,-0.12969798817452496,-0.11725958933841533],\n\"2.5%\":[-0.2646937839901558,-0.21544636873280976,-0.23981586709260283,-0.24592148277448506,-0.16741793715498826,-0.15657366276689025,-0.20237330351720398,-0.21300958471636788,-0.20669148807204774,-0.28417210141476024,-0.3238043269330341,-0.2099485227362348,-0.15409717460661623,-0.11056264387154215,0.057008975252615834,0.21463716944760447,0.2391081162035139,0.33982502387038716,0.3030291624102585,0.27828503291377715,0.2930538712475217,0.29968376424169435,-0.23793906288420313,-0.27354535803545277,-0.29912440202624146,-0.335869887028804,-0.3129969653284205,-0.2982050869771893,-0.28783945099742764,-0.338540190677748,-0.29429873236483706,-0.3202294529771482,-0.3275012806339604,-0.2472562205276551,-0.23810604300131347,-0.2851170666800976,-0.2961092474999363,-0.2873663093576493,-0.36060638058034633,-0.3925528126109618,-0.27270701237874767,-0.20991414177136553,-0.15173571251464024,0.01657899214025553,0.16150231678308602,0.1787519328054172,0.27534004027434267,0.2350138109016439,0.2079418736529148,0.2191010591967379,0.22405380762382524,-0.3163164823835121,-0.35268229694706366,-0.379662337896984,-0.4203557577197554,-0.3966451677311641,-0.38299361032761015,-0.3736709363541624],\n\"97.5%\":[0.028828104497032978,0.09797300701103423,0.07980899547805448,0.07833879479619989,0.14992023487360384,0.16749814103130964,0.1265134590690383,0.11729179414516971,0.11397172303440349,0.01963596416589633,-0.05054546097103818,0.03950153481909366,0.0677619834311628,0.05309050331625993,0.21770853433676934,0.4258355607865091,0.47900957827242063,0.5961374839234591,0.573373994561488,0.5578823467783746,0.5869986957251005,0.6002948391528184,0.07359252298584044,0.04100513670560291,0.020994722139788535,-5.866170266788373E-5,0.019484727947215896,0.038809110628139326,0.053320272320596954,0.10267451118462513,0.1768253706430615,0.1602225813625999,0.1599185926556752,0.2297585182462707,0.24903052126573286,0.20925722223193194,0.20039145692873814,0.19464654432000505,0.09607024333148248,0.018203024706889503,0.10226002446160654,0.12357895059591206,0.09426357195935803,0.25813851744912963,0.47897041345102753,0.5393657616705173,0.6606224675195036,0.6413893460701026,0.6282255060392369,0.6609515077758843,0.6759247957706875,0.1519699424851494,0.1201420756172138,0.1015326580105311,0.08442720898828357,0.10313293034995955,0.12359763397856025,0.13915175767733168],\n\"Model\":[\"Y ~ i(year, ever_treated,  ref = 14) | unit + year\",\"Y ~ i(year, ever_treated,  ref = 14) | unit + year\",\"Y ~ i(year, ever_treated,  ref = 14) | unit + year\",\"Y ~ i(year, ever_treated,  ref = 14) | unit + year\",\"Y ~ i(year, ever_treated,  ref = 14) | unit + year\",\"Y ~ i(year, ever_treated,  ref = 14) | unit + year\",\"Y ~ i(year, ever_treated,  ref = 14) | unit + year\",\"Y ~ i(year, ever_treated,  ref = 14) | unit + year\",\"Y ~ i(year, ever_treated,  ref = 14) | unit + year\",\"Y ~ i(year, ever_treated,  ref = 14) | unit + year\",\"Y ~ i(year, ever_treated,  ref = 14) | unit + year\",\"Y ~ i(year, ever_treated,  ref = 14) | unit + year\",\"Y ~ i(year, ever_treated,  ref = 14) | unit + year\",\"Y ~ i(year, ever_treated,  ref = 14) | unit + year\",\"Y ~ i(year, ever_treated,  ref = 14) | unit + year\",\"Y ~ i(year, ever_treated,  ref = 14) | unit + year\",\"Y ~ i(year, ever_treated,  ref = 14) | unit + year\",\"Y ~ i(year, ever_treated,  ref = 14) | unit + year\",\"Y ~ i(year, ever_treated,  ref = 14) | unit + year\",\"Y ~ i(year, ever_treated,  ref = 14) | unit + year\",\"Y ~ i(year, ever_treated,  ref = 14) | unit + year\",\"Y ~ i(year, ever_treated,  ref = 14) | unit + year\",\"Y ~ i(year, ever_treated,  ref = 14) | unit + year\",\"Y ~ i(year, ever_treated,  ref = 14) | unit + year\",\"Y ~ i(year, ever_treated,  ref = 14) | unit + year\",\"Y ~ i(year, ever_treated,  ref = 14) | unit + year\",\"Y ~ i(year, ever_treated,  ref = 14) | unit + year\",\"Y ~ i(year, ever_treated,  ref = 14) | unit + year\",\"Y ~ i(year, ever_treated,  ref = 14) | unit + year\",\"Y ~ i(year, ever_treated,  ref = 14) | unit + year (joint CIs)\",\"Y ~ i(year, ever_treated,  ref = 14) | unit + year (joint CIs)\",\"Y ~ i(year, ever_treated,  ref = 14) | unit + year (joint CIs)\",\"Y ~ i(year, ever_treated,  ref = 14) | unit + year (joint CIs)\",\"Y ~ i(year, ever_treated,  ref = 14) | unit + year (joint CIs)\",\"Y ~ i(year, ever_treated,  ref = 14) | unit + year (joint CIs)\",\"Y ~ i(year, ever_treated,  ref = 14) | unit + year (joint CIs)\",\"Y ~ i(year, ever_treated,  ref = 14) | unit + year (joint CIs)\",\"Y ~ i(year, ever_treated,  ref = 14) | unit + year (joint CIs)\",\"Y ~ i(year, ever_treated,  ref = 14) | unit + year (joint CIs)\",\"Y ~ i(year, ever_treated,  ref = 14) | unit + year (joint CIs)\",\"Y ~ i(year, ever_treated,  ref = 14) | unit + year (joint CIs)\",\"Y ~ i(year, ever_treated,  ref = 14) | unit + year (joint CIs)\",\"Y ~ i(year, ever_treated,  ref = 14) | unit + year (joint CIs)\",\"Y ~ i(year, ever_treated,  ref = 14) | unit + year (joint CIs)\",\"Y ~ i(year, ever_treated,  ref = 14) | unit + year (joint CIs)\",\"Y ~ i(year, ever_treated,  ref = 14) | unit + year (joint CIs)\",\"Y ~ i(year, ever_treated,  ref = 14) | unit + year (joint CIs)\",\"Y ~ i(year, ever_treated,  ref = 14) | unit + year (joint CIs)\",\"Y ~ i(year, ever_treated,  ref = 14) | unit + year (joint CIs)\",\"Y ~ i(year, ever_treated,  ref = 14) | unit + year (joint CIs)\",\"Y ~ i(year, ever_treated,  ref = 14) | unit + year (joint CIs)\",\"Y ~ i(year, ever_treated,  ref = 14) | unit + year (joint CIs)\",\"Y ~ i(year, ever_treated,  ref = 14) | unit + year (joint CIs)\",\"Y ~ i(year, ever_treated,  ref = 14) | unit + year (joint CIs)\",\"Y ~ i(year, ever_treated,  ref = 14) | unit + year (joint CIs)\",\"Y ~ i(year, ever_treated,  ref = 14) | unit + year (joint CIs)\",\"Y ~ i(year, ever_treated,  ref = 14) | unit + year (joint CIs)\",\"Y ~ i(year, ever_treated,  ref = 14) | unit + year (joint CIs)\"]\n},\n\"mapping\":{\n\"x\":\"Coefficient\",\n\"y\":\"Estimate\",\n\"color\":\"Model\"\n},\n\"data_meta\":{\n\"series_annotations\":[{\n\"type\":\"int\",\n\"column\":\"level_0\"\n},{\n\"type\":\"int\",\n\"column\":\"index\"\n},{\n\"type\":\"str\",\n\"column\":\"Coefficient\"\n},{\n\"type\":\"float\",\n\"column\":\"Estimate\"\n},{\n\"type\":\"float\",\n\"column\":\"Std. Error\"\n},{\n\"type\":\"float\",\n\"column\":\"t value\"\n},{\n\"type\":\"float\",\n\"column\":\"Pr(>|t|)\"\n},{\n\"type\":\"float\",\n\"column\":\"2.5%\"\n},{\n\"type\":\"float\",\n\"column\":\"97.5%\"\n},{\n\"type\":\"str\",\n\"column\":\"Model\"\n}]\n},\n\"guides\":{\n\"y\":{\n\"title\":\"Estimate and 95.0% Confidence Interval\"\n}\n},\n\"ggsize\":{\n\"width\":1200.0,\n\"height\":400.0\n},\n\"theme\":{\n\"axis_text_x\":{\n\"angle\":0.0,\n\"blank\":false\n}\n},\n\"ggtitle\":{\n\"text\":\"Event Study\"\n},\n\"kind\":\"plot\",\n\"scales\":[],\n\"layers\":[{\n\"geom\":\"point\",\n\"mapping\":{\n},\n\"position\":{\n\"name\":\"dodge\",\n\"width\":0.5\n},\n\"data_meta\":{\n},\n\"data\":{\n}\n},{\n\"geom\":\"errorbar\",\n\"mapping\":{\n\"ymin\":\"2.5%\",\n\"ymax\":\"97.5%\"\n},\n\"position\":{\n\"name\":\"dodge\",\n\"width\":0.5\n},\n\"data_meta\":{\n},\n\"width\":0.05,\n\"data\":{\n}\n},{\n\"geom\":\"hline\",\n\"mapping\":{\n},\n\"data_meta\":{\n},\n\"yintercept\":0.0,\n\"linetype\":\"dashed\",\n\"color\":\"black\",\n\"data\":{\n}\n},{\n\"geom\":\"vline\",\n\"mapping\":{\n},\n\"data_meta\":{\n},\n\"xintercept\":13.5,\n\"linetype\":\"dashed\",\n\"color\":\"black\",\n\"data\":{\n}\n}],\n\"metainfo_list\":[],\n\"spec_id\":\"2\"\n};\n           window.letsPlotCall(function() { fig = LetsPlot.buildPlotFromProcessedSpecs(plotSpec, containerDiv, sizing); });\n       } else {\n           fig.updateView({});\n       }\n   }\n   \n   const renderImmediately = \n       forceImmediateRender || (\n           sizing.width_mode === 'FIXED' && \n           (sizing.height_mode === 'FIXED' || sizing.height_mode === 'SCALED')\n       );\n   \n   if (renderImmediately) {\n       renderPlot();\n   }\n   \n   if (!renderImmediately || responsive) {\n       // Set up observer for initial sizing or continuous monitoring\n       var observer = new ResizeObserver(function(entries) {\n           for (let entry of entries) {\n               if (entry.contentBoxSize && \n                   entry.contentBoxSize[0].inlineSize > 0) {\n                   if (!responsive && observer) {\n                       observer.disconnect();\n                       observer = null;\n                   }\n                   renderPlot();\n                   if (!responsive) {\n                       break;\n                   }\n               }\n           }\n       });\n       \n       observer.observe(containerDiv);\n   }\n   \n   // ----------\n   })();\n   \n   </script>\n```\n:::\n:::\n\n\nThe joint confidence bands are wider than the pointwise confidence intervals, and they include zero for all pre-treatment coefficients. This is consistent with the parallel trends assumption.\n\n## Event Study under Staggered Adoption via `feols()`, `event_study()`, `did2s()`,  `lpdid()`\n\nWe now return to the data set with staggered treatment rollout, `df_multi_cohort`.\n\n### Two-Way Fixed Effects\n\nAs a baseline model, we can estimate a simple two-way fixed effects DiD regression via `feols()`:\n\n::: {#c5564d19 .cell execution_count=13}\n``` {.python .cell-code}\nfit_twfe = pf.feols(\n    \"dep_var ~ i(rel_year, ref=-1.0) | state + year\",\n    df_multi_cohort,\n    vcov={\"CRV1\": \"state\"},\n)\n```\n:::\n\n\nYou can also estimate a TWFE model via the `event_study()` function, which aims to provide a common interface to multiple\ndifference-in-differences implementations:\n\n::: {#ad5a904a .cell execution_count=14}\n``` {.python .cell-code}\nfit_twfe_event = pf.event_study(\n    data=df_multi_cohort,\n    yname=\"dep_var\",\n    idname=\"unit\",\n    tname=\"year\",\n    gname=\"g\",\n    estimator=\"twfe\",\n)\n```\n:::\n\n\n### Fully-Interacted / Saturated Event Study (Sun-Abraham)\n\nIn a similar spirit, you can fit a fully-interacted difference-in-differences model by selecting the `estimator = \"saturated\"`:\n\n::: {#a2bfb019 .cell execution_count=15}\n``` {.python .cell-code}\nfit_saturated = pf.event_study(\n    data=df_multi_cohort,\n    yname=\"dep_var\",\n    idname=\"unit\",\n    tname=\"year\",\n    gname=\"g\",\n    estimator=\"saturated\",\n)\n\nfit_saturated.iplot()\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n/Users/afischer/Documents/pyfixest/pyfixest/did/saturated_twfe.py:68: UserWarning: The SaturatedEventStudyClass is currently in beta. Please report any issues you may encounter.\n  warnings.warn(\n/Users/afischer/Documents/pyfixest/pyfixest/estimation/models/feols_.py:2772: UserWarning: \n            22 variables dropped due to multicollinearity.\n            The following variables are dropped: \n    rel_time::-20.0:first_treated_period::2000\n    rel_time::-19.0:first_treated_period::2000\n    rel_time::-18.0:first_treated_period::2000\n    rel_time::-17.0:first_treated_period::2000\n    rel_time::-16.0:first_treated_period::2000\n    ....\n            \n  warnings.warn(\n```\n:::\n\n::: {.cell-output .cell-output-display}\n![](difference-in-differences_files/figure-html/cell-16-output-2.png){width=949 height=564}\n:::\n:::\n\n\nWe can obtain treatment effects by period via the `aggregate()` method\n\n::: {#066ad83b .cell execution_count=16}\n``` {.python .cell-code}\nfit_saturated.aggregate(weighting = \"shares\")\n```\n\n::: {.cell-output .cell-output-display execution_count=16}\n```{=html}\n<div>\n<style scoped>\n    .dataframe tbody tr th:only-of-type {\n        vertical-align: middle;\n    }\n\n    .dataframe tbody tr th {\n        vertical-align: top;\n    }\n\n    .dataframe thead th {\n        text-align: right;\n    }\n</style>\n<table border=\"1\" class=\"dataframe\">\n  <thead>\n    <tr style=\"text-align: right;\">\n      <th></th>\n      <th>Estimate</th>\n      <th>Std. Error</th>\n      <th>t value</th>\n      <th>Pr(&gt;|t|)</th>\n      <th>2.5%</th>\n      <th>97.5%</th>\n    </tr>\n    <tr>\n      <th>period</th>\n      <th></th>\n      <th></th>\n      <th></th>\n      <th></th>\n      <th></th>\n      <th></th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <th>-20.0</th>\n      <td>-0.073055</td>\n      <td>0.083868</td>\n      <td>-0.871071</td>\n      <td>0.383715</td>\n      <td>-0.237434</td>\n      <td>0.091324</td>\n    </tr>\n    <tr>\n      <th>-19.0</th>\n      <td>-0.005748</td>\n      <td>0.087254</td>\n      <td>-0.065871</td>\n      <td>0.94748</td>\n      <td>-0.176763</td>\n      <td>0.165268</td>\n    </tr>\n    <tr>\n      <th>-18.0</th>\n      <td>0.019863</td>\n      <td>0.084817</td>\n      <td>0.234181</td>\n      <td>0.814844</td>\n      <td>-0.146376</td>\n      <td>0.186101</td>\n    </tr>\n    <tr>\n      <th>-17.0</th>\n      <td>0.075561</td>\n      <td>0.08836</td>\n      <td>0.85515</td>\n      <td>0.392468</td>\n      <td>-0.097622</td>\n      <td>0.248744</td>\n    </tr>\n    <tr>\n      <th>-16.0</th>\n      <td>-0.051278</td>\n      <td>0.088165</td>\n      <td>-0.581611</td>\n      <td>0.560829</td>\n      <td>-0.224077</td>\n      <td>0.121522</td>\n    </tr>\n    <tr>\n      <th>-15.0</th>\n      <td>0.047891</td>\n      <td>0.085371</td>\n      <td>0.560977</td>\n      <td>0.574813</td>\n      <td>-0.119433</td>\n      <td>0.215215</td>\n    </tr>\n    <tr>\n      <th>-14.0</th>\n      <td>0.030061</td>\n      <td>0.085232</td>\n      <td>0.352697</td>\n      <td>0.724316</td>\n      <td>-0.13699</td>\n      <td>0.197112</td>\n    </tr>\n    <tr>\n      <th>-13.0</th>\n      <td>0.03987</td>\n      <td>0.082118</td>\n      <td>0.485517</td>\n      <td>0.62731</td>\n      <td>-0.121079</td>\n      <td>0.200818</td>\n    </tr>\n    <tr>\n      <th>-12.0</th>\n      <td>0.048458</td>\n      <td>0.087172</td>\n      <td>0.555888</td>\n      <td>0.578287</td>\n      <td>-0.122396</td>\n      <td>0.219312</td>\n    </tr>\n    <tr>\n      <th>-11.0</th>\n      <td>-0.01282</td>\n      <td>0.091618</td>\n      <td>-0.13993</td>\n      <td>0.888715</td>\n      <td>-0.192388</td>\n      <td>0.166748</td>\n    </tr>\n    <tr>\n      <th>-10.0</th>\n      <td>0.001529</td>\n      <td>0.06211</td>\n      <td>0.02461</td>\n      <td>0.980366</td>\n      <td>-0.120205</td>\n      <td>0.123262</td>\n    </tr>\n    <tr>\n      <th>-9.0</th>\n      <td>0.017902</td>\n      <td>0.062642</td>\n      <td>0.285777</td>\n      <td>0.775049</td>\n      <td>-0.104874</td>\n      <td>0.140677</td>\n    </tr>\n    <tr>\n      <th>-8.0</th>\n      <td>0.02942</td>\n      <td>0.062148</td>\n      <td>0.473384</td>\n      <td>0.635939</td>\n      <td>-0.092389</td>\n      <td>0.151229</td>\n    </tr>\n    <tr>\n      <th>-7.0</th>\n      <td>0.06927</td>\n      <td>0.06336</td>\n      <td>1.093268</td>\n      <td>0.274276</td>\n      <td>-0.054914</td>\n      <td>0.193453</td>\n    </tr>\n    <tr>\n      <th>-6.0</th>\n      <td>-0.000168</td>\n      <td>0.06252</td>\n      <td>-0.002687</td>\n      <td>0.997856</td>\n      <td>-0.122705</td>\n      <td>0.122369</td>\n    </tr>\n    <tr>\n      <th>-5.0</th>\n      <td>-0.042447</td>\n      <td>0.060507</td>\n      <td>-0.701529</td>\n      <td>0.482973</td>\n      <td>-0.161039</td>\n      <td>0.076144</td>\n    </tr>\n    <tr>\n      <th>-4.0</th>\n      <td>0.025822</td>\n      <td>0.061739</td>\n      <td>0.418243</td>\n      <td>0.67577</td>\n      <td>-0.095185</td>\n      <td>0.146828</td>\n    </tr>\n    <tr>\n      <th>-3.0</th>\n      <td>0.062146</td>\n      <td>0.061508</td>\n      <td>1.010385</td>\n      <td>0.312311</td>\n      <td>-0.058406</td>\n      <td>0.182699</td>\n    </tr>\n    <tr>\n      <th>-2.0</th>\n      <td>0.031255</td>\n      <td>0.06339</td>\n      <td>0.493059</td>\n      <td>0.621971</td>\n      <td>-0.092988</td>\n      <td>0.155498</td>\n    </tr>\n    <tr>\n      <th>0.0</th>\n      <td>1.38732</td>\n      <td>0.061787</td>\n      <td>22.453107</td>\n      <td>0.0</td>\n      <td>1.266219</td>\n      <td>1.508421</td>\n    </tr>\n    <tr>\n      <th>1.0</th>\n      <td>1.628963</td>\n      <td>0.063322</td>\n      <td>25.724928</td>\n      <td>0.0</td>\n      <td>1.504854</td>\n      <td>1.753073</td>\n    </tr>\n    <tr>\n      <th>2.0</th>\n      <td>1.686253</td>\n      <td>0.062372</td>\n      <td>27.035432</td>\n      <td>0.0</td>\n      <td>1.564007</td>\n      <td>1.8085</td>\n    </tr>\n    <tr>\n      <th>3.0</th>\n      <td>1.796582</td>\n      <td>0.063137</td>\n      <td>28.455425</td>\n      <td>0.0</td>\n      <td>1.672837</td>\n      <td>1.920328</td>\n    </tr>\n    <tr>\n      <th>4.0</th>\n      <td>1.934649</td>\n      <td>0.063037</td>\n      <td>30.690833</td>\n      <td>0.0</td>\n      <td>1.8111</td>\n      <td>2.058199</td>\n    </tr>\n    <tr>\n      <th>5.0</th>\n      <td>2.065588</td>\n      <td>0.061803</td>\n      <td>33.422231</td>\n      <td>0.0</td>\n      <td>1.944456</td>\n      <td>2.186719</td>\n    </tr>\n    <tr>\n      <th>6.0</th>\n      <td>2.166252</td>\n      <td>0.064074</td>\n      <td>33.808421</td>\n      <td>0.0</td>\n      <td>2.040668</td>\n      <td>2.291835</td>\n    </tr>\n    <tr>\n      <th>7.0</th>\n      <td>2.263413</td>\n      <td>0.06352</td>\n      <td>35.632879</td>\n      <td>0.0</td>\n      <td>2.138916</td>\n      <td>2.387911</td>\n    </tr>\n    <tr>\n      <th>8.0</th>\n      <td>2.358293</td>\n      <td>0.06232</td>\n      <td>37.841747</td>\n      <td>0.0</td>\n      <td>2.236149</td>\n      <td>2.480438</td>\n    </tr>\n    <tr>\n      <th>9.0</th>\n      <td>2.354538</td>\n      <td>0.056481</td>\n      <td>41.687038</td>\n      <td>0.0</td>\n      <td>2.243837</td>\n      <td>2.465239</td>\n    </tr>\n    <tr>\n      <th>10.0</th>\n      <td>2.515993</td>\n      <td>0.060297</td>\n      <td>41.72651</td>\n      <td>0.0</td>\n      <td>2.397813</td>\n      <td>2.634174</td>\n    </tr>\n    <tr>\n      <th>11.0</th>\n      <td>2.552978</td>\n      <td>0.092825</td>\n      <td>27.503048</td>\n      <td>0.0</td>\n      <td>2.371044</td>\n      <td>2.734912</td>\n    </tr>\n    <tr>\n      <th>12.0</th>\n      <td>2.603939</td>\n      <td>0.090658</td>\n      <td>28.722574</td>\n      <td>0.0</td>\n      <td>2.426252</td>\n      <td>2.781625</td>\n    </tr>\n    <tr>\n      <th>13.0</th>\n      <td>2.578044</td>\n      <td>0.093739</td>\n      <td>27.502403</td>\n      <td>0.0</td>\n      <td>2.394319</td>\n      <td>2.761769</td>\n    </tr>\n    <tr>\n      <th>14.0</th>\n      <td>2.722969</td>\n      <td>0.092043</td>\n      <td>29.583642</td>\n      <td>0.0</td>\n      <td>2.542568</td>\n      <td>2.90337</td>\n    </tr>\n    <tr>\n      <th>15.0</th>\n      <td>2.909275</td>\n      <td>0.092438</td>\n      <td>31.472726</td>\n      <td>0.0</td>\n      <td>2.7281</td>\n      <td>3.09045</td>\n    </tr>\n    <tr>\n      <th>16.0</th>\n      <td>2.859325</td>\n      <td>0.092643</td>\n      <td>30.864025</td>\n      <td>0.0</td>\n      <td>2.677749</td>\n      <td>3.040901</td>\n    </tr>\n    <tr>\n      <th>17.0</th>\n      <td>2.907943</td>\n      <td>0.093763</td>\n      <td>31.013703</td>\n      <td>0.0</td>\n      <td>2.724171</td>\n      <td>3.091716</td>\n    </tr>\n    <tr>\n      <th>18.0</th>\n      <td>2.873678</td>\n      <td>0.093009</td>\n      <td>30.896721</td>\n      <td>0.0</td>\n      <td>2.691384</td>\n      <td>3.055973</td>\n    </tr>\n    <tr>\n      <th>19.0</th>\n      <td>2.882807</td>\n      <td>0.09253</td>\n      <td>31.155532</td>\n      <td>0.0</td>\n      <td>2.701453</td>\n      <td>3.064162</td>\n    </tr>\n    <tr>\n      <th>20.0</th>\n      <td>2.911501</td>\n      <td>0.091093</td>\n      <td>31.961938</td>\n      <td>0.0</td>\n      <td>2.732962</td>\n      <td>3.09004</td>\n    </tr>\n  </tbody>\n</table>\n</div>\n```\n:::\n:::\n\n\nand plot the effects\n\n::: {#2907a1c3 .cell execution_count=17}\n``` {.python .cell-code}\nfit_saturated.iplot_aggregate(weighting = \"shares\")\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n/Users/afischer/Documents/pyfixest/pyfixest/did/saturated_twfe.py:270: UserWarning: No artists with labels found to put in legend.  Note that artists whose label start with an underscore are ignored when legend() is called with no argument.\n  ax.legend()\n```\n:::\n\n::: {.cell-output .cell-output-display}\n![](difference-in-differences_files/figure-html/cell-18-output-2.png){width=949 height=564}\n:::\n:::\n\n\n### When can we get away with using the two-way fixed effects regression?\n\nWe will motivate this section by lazily quoting the abstract of [Lal (2025)](https://arxiv.org/abs/2503.05125):\n\n> The use of the two-way fixed effects regression in empirical social science was historically motivated by folk wisdom that it uncovers the Average Treatment effect on the Treated (ATT) as in the canonical two-period two-group case. This belief has come under scrutiny recently due to recent results in applied econometrics showing that it fails to uncover meaningful averages of heterogeneous treatment effects in the presence of effect heterogeneity over time and across adoption cohorts, and several heterogeneity-robust alternatives have been proposed. However, these estimators often have higher variance and are therefore under-powered for many applications, which poses a bias-variance tradeoff that is challenging for researchers to navigate. In this paper, we propose simple tests of linear restrictions that can be used to test for differences in dynamic treatment effects over cohorts, which allows us to test for when the two-way fixed effects regression is likely to yield biased estimates of the ATT.\n\nYou can employ the proposed test after running a saturated event study by calling the `test_treatment_heterogeneity()` method:\n\n::: {#a9dd09ad .cell execution_count=18}\n``` {.python .cell-code}\nfit_saturated.test_treatment_heterogeneity()\n```\n\n::: {.cell-output .cell-output-display execution_count=18}\n```\nstatistic    3256.497337\npvalue          0.000000\ndtype: float64\n```\n:::\n:::\n\n\nIn this case, we might be willing to rely on the simple TWFE model to produce unbiased estimates. If we're not, two \"new\" difference-in-differences\nestimators are implemented (beyond the already-presented saturated Sun-Abraham approach) that produce unbiased estimates under staggered assignment and heterogeneous treatment effects: Gardner's 2-Step Estimator and the Local Projections estimator from Dube et al.\n\n### Gardner's 2-Step Estimator\n\nTo do the same via Gardners 2-stage estimator, we employ the the `pf.did2s()` function:\n\n::: {#aa9054b6 .cell execution_count=19}\n``` {.python .cell-code}\nfit_did2s = pf.did2s(\n    df_multi_cohort,\n    yname=\"dep_var\",\n    first_stage=\"~ 0 | unit + year\",\n    second_stage=\"~i(rel_year,ref=-1.0)\",\n    treatment=\"treat\",\n    cluster=\"state\",\n)\n```\n:::\n\n\n### Local Projections (Dube et al)\n\nLast, we can estimate the ATT for each time period via local projections by using the `lpdid()` function:\n\n::: {#c3e69f1b .cell execution_count=20}\n``` {.python .cell-code}\nfit_lpdid = pf.lpdid(\n    data=df_multi_cohort,\n    yname=\"dep_var\",\n    gname=\"g\",\n    tname=\"year\",\n    idname=\"unit\",\n    vcov={\"CRV1\": \"state\"},\n    pre_window=-20,\n    post_window=20,\n    att=False,\n)\n```\n:::\n\n\nLet's look at some results:\n\n::: {#af41c18a .cell execution_count=21}\n``` {.python .cell-code}\nfigsize = [1200, 400]\n```\n:::\n\n\n::: {#28791aec .cell execution_count=22}\n``` {.python .cell-code}\nfit_twfe.iplot(\n    coord_flip=False,\n    title=\"TWFE-Estimator\",\n    figsize=figsize,\n    xintercept=18.5,\n    yintercept=0,\n    labels=rename_event_study_coefs(fit_twfe._coefnames),  # rename coefficients\n).show()\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n/var/folders/98/c353q4p95v5_fz62gr5c9td80000gn/T/ipykernel_15240/383819466.py:7: DeprecationWarning: The function `_relabel_expvar` is deprecated as we have adjusted the naming of variables interacted via the i() operator with pyfixest 0.50. For regression tables, please rely on the `labels` and `cat_template` arguments of `pf.etable()` instead. \n  labels=rename_event_study_coefs(fit_twfe._coefnames),  # rename coefficients\n```\n:::\n\n::: {.cell-output .cell-output-display}\n```{=html}\n   <div id=\"EzPXHW\"></div>\n   <script type=\"text/javascript\" data-lets-plot-script=\"plot\">\n   \n   (function() {\n   // ----------\n   \n   const forceImmediateRender = false;\n   const responsive = false;\n   \n   let sizing = {\n       width_mode: \"MIN\",\n       height_mode: \"SCALED\",\n       width: null, \n       height: null \n   };\n   \n   const preferredWidth = document.body.dataset.letsPlotPreferredWidth;\n   if (preferredWidth !== undefined) {\n       sizing = {\n           width_mode: 'FIXED',\n           height_mode: 'SCALED',\n           width: parseFloat(preferredWidth)\n       };\n   }\n   \n   const containerDiv = document.getElementById(\"EzPXHW\");\n   let fig = null;\n   \n   function renderPlot() {\n       if (fig === null) {\n           const plotSpec = {\n\"data\":{\n\"Coefficient\":[\"rel_year::-inf\",\"rel_year::-20.0\",\"rel_year::-19.0\",\"rel_year::-18.0\",\"rel_year::-17.0\",\"rel_year::-16.0\",\"rel_year::-15.0\",\"rel_year::-14.0\",\"rel_year::-13.0\",\"rel_year::-12.0\",\"rel_year::-11.0\",\"rel_year::-10.0\",\"rel_year::-9.0\",\"rel_year::-8.0\",\"rel_year::-7.0\",\"rel_year::-6.0\",\"rel_year::-5.0\",\"rel_year::-4.0\",\"rel_year::-3.0\",\"rel_year::-2.0\",\"rel_year::0.0\",\"rel_year::1.0\",\"rel_year::2.0\",\"rel_year::3.0\",\"rel_year::4.0\",\"rel_year::5.0\",\"rel_year::6.0\",\"rel_year::7.0\",\"rel_year::8.0\",\"rel_year::9.0\",\"rel_year::10.0\",\"rel_year::11.0\",\"rel_year::12.0\",\"rel_year::13.0\",\"rel_year::14.0\",\"rel_year::15.0\",\"rel_year::16.0\",\"rel_year::17.0\",\"rel_year::18.0\",\"rel_year::19.0\",\"rel_year::20.0\"],\n\"Estimate\":[0.1280530624356816,-0.09944466441186448,6.235199753501709E-4,0.0041247661866553684,0.02189908545943477,-0.036933408828411306,0.06957783836537086,0.03773442317027258,0.06177914337444653,0.08991270466787236,9.822487465295502E-4,-0.11303282051986834,-0.06922462711950585,-0.061289513093680255,-0.0020224309371402924,-0.05580979472639471,-0.06500868193870427,-0.00984995980723369,0.04633807990092391,0.015947312893723933,1.4064044908225413,1.6605518884803565,1.7287900538934713,1.8548389960026528,1.9586760781129011,2.0821612836358008,2.1910619949212764,2.2790728423713893,2.364593439335071,2.372162693677217,2.649271188090771,2.7535908715364057,2.813935474227433,2.756069650642718,2.8634270216427087,2.9866523455331992,2.9630322165964853,2.9725964211140496,2.9350513290125866,2.918706513680961,2.979701202491552],\n\"2.5%\":[-0.030807746498103084,-0.26475239089988456,-0.16774636908212087,-0.17740998253548135,-0.15147558902858788,-0.23303994198673786,-0.09489875317322578,-0.13752593665097146,-0.10689188479563178,-0.08187083528886142,-0.15907464527284126,-0.24439448942406938,-0.18465024083969267,-0.18342347916192348,-0.1327365037530943,-0.18666932874007547,-0.19614293346991066,-0.11728679973915693,-0.08103372597214172,-0.11646532546430118,1.2938224522235822,1.5289656538600842,1.6138766603497952,1.7368465942004028,1.8147261521226423,1.9529592610149542,2.0524404216411454,2.127291831867131,2.246027280469074,2.257721255734429,2.5356035511883035,2.6007745601483148,2.6534428144558433,2.5975022579559433,2.6643497148185857,2.797853336994778,2.790181663157508,2.7856582935921783,2.7446002811505545,2.7483541440935637,2.802096879471444],\n\"97.5%\":[0.2869138713694663,0.06586306207615561,0.16899340903282123,0.18565951490879207,0.19527375994745744,0.15917312432991523,0.23405442990396752,0.21299478299151664,0.23045017154452485,0.26169624462460617,0.16103914276590037,0.018328848384332727,0.04620098660068098,0.06084445297456296,0.12869164187881368,0.07504973928728603,0.06612556959250213,0.09758688012468955,0.17370988577398955,0.14835995125174906,1.5189865294215004,1.7921381231006288,1.8437034474371474,1.9728313978049028,2.10262600410316,2.211363306256647,2.3296835682014074,2.430853852875648,2.4831595982010684,2.486604131620005,2.7629388249932387,2.9064071829244966,2.974428133999023,2.914637043329493,3.0625043284668316,3.1754513540716207,3.1358827700354626,3.159534548635921,3.1255023768746186,3.0890588832683585,3.15730552551166],\n\"Model\":[\"dep_var ~ i(rel_year, ref=-1.0) | state + year\",\"dep_var ~ i(rel_year, ref=-1.0) | state + year\",\"dep_var ~ i(rel_year, ref=-1.0) | state + year\",\"dep_var ~ i(rel_year, ref=-1.0) | state + year\",\"dep_var ~ i(rel_year, ref=-1.0) | state + year\",\"dep_var ~ i(rel_year, ref=-1.0) | state + year\",\"dep_var ~ i(rel_year, ref=-1.0) | state + year\",\"dep_var ~ i(rel_year, ref=-1.0) | state + year\",\"dep_var ~ i(rel_year, ref=-1.0) | state + year\",\"dep_var ~ i(rel_year, ref=-1.0) | state + year\",\"dep_var ~ i(rel_year, ref=-1.0) | state + year\",\"dep_var ~ i(rel_year, ref=-1.0) | state + year\",\"dep_var ~ i(rel_year, ref=-1.0) | state + year\",\"dep_var ~ i(rel_year, ref=-1.0) | state + year\",\"dep_var ~ i(rel_year, ref=-1.0) | state + year\",\"dep_var ~ i(rel_year, ref=-1.0) | state + year\",\"dep_var ~ i(rel_year, ref=-1.0) | state + year\",\"dep_var ~ i(rel_year, ref=-1.0) | state + year\",\"dep_var ~ i(rel_year, ref=-1.0) | state + year\",\"dep_var ~ i(rel_year, ref=-1.0) | state + year\",\"dep_var ~ i(rel_year, ref=-1.0) | state + year\",\"dep_var ~ i(rel_year, ref=-1.0) | state + year\",\"dep_var ~ i(rel_year, ref=-1.0) | state + year\",\"dep_var ~ i(rel_year, ref=-1.0) | state + year\",\"dep_var ~ i(rel_year, ref=-1.0) | state + year\",\"dep_var ~ i(rel_year, ref=-1.0) | state + year\",\"dep_var ~ i(rel_year, ref=-1.0) | state + year\",\"dep_var ~ i(rel_year, ref=-1.0) | state + year\",\"dep_var ~ i(rel_year, ref=-1.0) | state + year\",\"dep_var ~ i(rel_year, ref=-1.0) | state + year\",\"dep_var ~ i(rel_year, ref=-1.0) | state + year\",\"dep_var ~ i(rel_year, ref=-1.0) | state + year\",\"dep_var ~ i(rel_year, ref=-1.0) | state + year\",\"dep_var ~ i(rel_year, ref=-1.0) | state + year\",\"dep_var ~ i(rel_year, ref=-1.0) | state + year\",\"dep_var ~ i(rel_year, ref=-1.0) | state + year\",\"dep_var ~ i(rel_year, ref=-1.0) | state + year\",\"dep_var ~ i(rel_year, ref=-1.0) | state + year\",\"dep_var ~ i(rel_year, ref=-1.0) | state + year\",\"dep_var ~ i(rel_year, ref=-1.0) | state + year\",\"dep_var ~ i(rel_year, ref=-1.0) | state + year\"]\n},\n\"mapping\":{\n\"x\":\"Coefficient\",\n\"y\":\"Estimate\",\n\"color\":\"Model\"\n},\n\"data_meta\":{\n\"series_annotations\":[{\n\"type\":\"int\",\n\"column\":\"level_0\"\n},{\n\"type\":\"int\",\n\"column\":\"index\"\n},{\n\"type\":\"str\",\n\"column\":\"Coefficient\"\n},{\n\"type\":\"float\",\n\"column\":\"Estimate\"\n},{\n\"type\":\"float\",\n\"column\":\"Std. Error\"\n},{\n\"type\":\"float\",\n\"column\":\"t value\"\n},{\n\"type\":\"float\",\n\"column\":\"Pr(>|t|)\"\n},{\n\"type\":\"float\",\n\"column\":\"2.5%\"\n},{\n\"type\":\"float\",\n\"column\":\"97.5%\"\n},{\n\"type\":\"str\",\n\"column\":\"Model\"\n}]\n},\n\"guides\":{\n\"y\":{\n\"title\":\"Estimate and 95.0% Confidence Interval\"\n}\n},\n\"ggsize\":{\n\"width\":1200.0,\n\"height\":400.0\n},\n\"theme\":{\n\"axis_text_x\":{\n\"angle\":0.0,\n\"blank\":false\n}\n},\n\"ggtitle\":{\n\"text\":\"TWFE-Estimator\"\n},\n\"kind\":\"plot\",\n\"scales\":[],\n\"layers\":[{\n\"geom\":\"point\",\n\"mapping\":{\n},\n\"position\":{\n\"name\":\"dodge\",\n\"width\":0.5\n},\n\"data_meta\":{\n},\n\"data\":{\n}\n},{\n\"geom\":\"errorbar\",\n\"mapping\":{\n\"ymin\":\"2.5%\",\n\"ymax\":\"97.5%\"\n},\n\"position\":{\n\"name\":\"dodge\",\n\"width\":0.5\n},\n\"data_meta\":{\n},\n\"width\":0.05,\n\"data\":{\n}\n},{\n\"geom\":\"hline\",\n\"mapping\":{\n},\n\"data_meta\":{\n},\n\"yintercept\":0.0,\n\"linetype\":\"dashed\",\n\"color\":\"black\",\n\"data\":{\n}\n},{\n\"geom\":\"vline\",\n\"mapping\":{\n},\n\"data_meta\":{\n},\n\"xintercept\":18.5,\n\"linetype\":\"dashed\",\n\"color\":\"black\",\n\"data\":{\n}\n}],\n\"metainfo_list\":[],\n\"spec_id\":\"3\"\n};\n           window.letsPlotCall(function() { fig = LetsPlot.buildPlotFromProcessedSpecs(plotSpec, containerDiv, sizing); });\n       } else {\n           fig.updateView({});\n       }\n   }\n   \n   const renderImmediately = \n       forceImmediateRender || (\n           sizing.width_mode === 'FIXED' && \n           (sizing.height_mode === 'FIXED' || sizing.height_mode === 'SCALED')\n       );\n   \n   if (renderImmediately) {\n       renderPlot();\n   }\n   \n   if (!renderImmediately || responsive) {\n       // Set up observer for initial sizing or continuous monitoring\n       var observer = new ResizeObserver(function(entries) {\n           for (let entry of entries) {\n               if (entry.contentBoxSize && \n                   entry.contentBoxSize[0].inlineSize > 0) {\n                   if (!responsive && observer) {\n                       observer.disconnect();\n                       observer = null;\n                   }\n                   renderPlot();\n                   if (!responsive) {\n                       break;\n                   }\n               }\n           }\n       });\n       \n       observer.observe(containerDiv);\n   }\n   \n   // ----------\n   })();\n   \n   </script>\n```\n:::\n:::\n\n\n::: {#59c8d3ae .cell execution_count=23}\n``` {.python .cell-code}\nfit_lpdid.iplot(\n    coord_flip=False,\n    title=\"Local-Projections-Estimator\",\n    figsize=figsize,\n    yintercept=0,\n    xintercept=18.5,\n).show()\n```\n\n::: {.cell-output .cell-output-display}\n```{=html}\n   <div id=\"B95hi0\"></div>\n   <script type=\"text/javascript\" data-lets-plot-script=\"plot\">\n   \n   (function() {\n   // ----------\n   \n   const forceImmediateRender = false;\n   const responsive = false;\n   \n   let sizing = {\n       width_mode: \"MIN\",\n       height_mode: \"SCALED\",\n       width: null, \n       height: null \n   };\n   \n   const preferredWidth = document.body.dataset.letsPlotPreferredWidth;\n   if (preferredWidth !== undefined) {\n       sizing = {\n           width_mode: 'FIXED',\n           height_mode: 'SCALED',\n           width: parseFloat(preferredWidth)\n       };\n   }\n   \n   const containerDiv = document.getElementById(\"B95hi0\");\n   let fig = null;\n   \n   function renderPlot() {\n       if (fig === null) {\n           const plotSpec = {\n\"data\":{\n\"Coefficient\":[\"time_to_treatment::-20\",\"time_to_treatment::-19\",\"time_to_treatment::-18\",\"time_to_treatment::-17\",\"time_to_treatment::-16\",\"time_to_treatment::-15\",\"time_to_treatment::-14\",\"time_to_treatment::-13\",\"time_to_treatment::-12\",\"time_to_treatment::-11\",\"time_to_treatment::-10\",\"time_to_treatment::-9\",\"time_to_treatment::-8\",\"time_to_treatment::-7\",\"time_to_treatment::-6\",\"time_to_treatment::-5\",\"time_to_treatment::-4\",\"time_to_treatment::-3\",\"time_to_treatment::-2\",\"time_to_treatment::0\",\"time_to_treatment::1\",\"time_to_treatment::2\",\"time_to_treatment::3\",\"time_to_treatment::4\",\"time_to_treatment::5\",\"time_to_treatment::6\",\"time_to_treatment::7\",\"time_to_treatment::8\",\"time_to_treatment::9\",\"time_to_treatment::10\",\"time_to_treatment::11\",\"time_to_treatment::12\",\"time_to_treatment::13\",\"time_to_treatment::14\",\"time_to_treatment::15\",\"time_to_treatment::16\",\"time_to_treatment::17\",\"time_to_treatment::18\",\"time_to_treatment::19\",\"time_to_treatment::20\"],\n\"Estimate\":[-0.07305529455102057,-0.0057475394007537135,0.019862595898581595,0.0755613194783191,-0.05127756268425213,0.04789121634978956,0.030061024401231356,0.03986968384484262,0.048457897289846806,-0.012820133350277539,0.013685361040923886,0.005199898128597284,0.0164162774648373,0.05641673885681884,0.0016957198969680817,-0.06496834258802511,0.010741616233677911,0.04275993550129887,0.003229015933287153,1.452023474827307,1.6676220565025497,1.7336997045580052,1.8436118199851643,1.9620937493794017,2.0880835635857604,2.1819660437275696,2.254678404642132,2.3484735871275646,2.3603848643067784,2.516113933361753,2.552977994310091,2.603938509344384,2.5780442879020358,2.7229688455567262,2.9092747255962252,2.8593251547084924,2.907943168261159,2.8736781792414066,2.8828072503191615,2.911501018068635],\n\"2.5%\":[-0.2272172766523859,-0.1670700586084853,-0.17114762452140675,-0.09839081142269912,-0.22467756818724258,-0.1150076442883886,-0.13013451064997683,-0.13448828156159562,-0.11740856214252182,-0.17782121326670994,-0.11574797121541744,-0.11008024082082965,-0.10776451441715584,-0.06865967673907453,-0.12155178659801848,-0.18968244634962642,-0.09892973087903473,-0.07749915399392934,-0.1186507251302543,1.3363431157797139,1.5248748576801467,1.625286020209566,1.729437327544061,1.8189029384537494,1.9622427442587915,2.0418839300437477,2.1170793502306986,2.2273398370559057,2.2206593574383984,2.3975249304388946,2.3711839927988128,2.4122317211617528,2.40189162038278,2.5167480629209837,2.7210109316903197,2.6739497917518142,2.7277574304593997,2.658860445512023,2.671979873230292,2.7125289161146497],\n\"97.5%\":[0.08110668755034477,0.1555749798069779,0.2108728163185699,0.2495134503793373,0.12212244281873832,0.2107900769879677,0.19025655945243952,0.21422764925128088,0.21432435672221545,0.15218094656615486,0.1431186932972652,0.12048003707802421,0.14059706934683044,0.1814931544527122,0.12494322639195464,0.05974576117357619,0.12041296334639054,0.1630190249965271,0.1251087569968286,1.5677038338749003,1.8103692553249526,1.8421133889064443,1.9577863124262675,2.105284560305054,2.2139243829127295,2.3220481574113916,2.3922774590535654,2.4696073371992235,2.5001103711751584,2.6347029362846115,2.734771995821369,2.795645297527015,2.7541969554212917,2.9291896281924688,3.0975385195021308,3.0447005176651705,3.0881289060629187,3.08849591297079,3.093634627408031,3.11047312002262],\n\"Model\":[\"lpdid\",\"lpdid\",\"lpdid\",\"lpdid\",\"lpdid\",\"lpdid\",\"lpdid\",\"lpdid\",\"lpdid\",\"lpdid\",\"lpdid\",\"lpdid\",\"lpdid\",\"lpdid\",\"lpdid\",\"lpdid\",\"lpdid\",\"lpdid\",\"lpdid\",\"lpdid\",\"lpdid\",\"lpdid\",\"lpdid\",\"lpdid\",\"lpdid\",\"lpdid\",\"lpdid\",\"lpdid\",\"lpdid\",\"lpdid\",\"lpdid\",\"lpdid\",\"lpdid\",\"lpdid\",\"lpdid\",\"lpdid\",\"lpdid\",\"lpdid\",\"lpdid\",\"lpdid\"]\n},\n\"mapping\":{\n\"x\":\"Coefficient\",\n\"y\":\"Estimate\",\n\"color\":\"Model\"\n},\n\"data_meta\":{\n\"series_annotations\":[{\n\"type\":\"int\",\n\"column\":\"index\"\n},{\n\"type\":\"str\",\n\"column\":\"Coefficient\"\n},{\n\"type\":\"float\",\n\"column\":\"Estimate\"\n},{\n\"type\":\"float\",\n\"column\":\"Std. Error\"\n},{\n\"type\":\"float\",\n\"column\":\"t value\"\n},{\n\"type\":\"float\",\n\"column\":\"Pr(>|t|)\"\n},{\n\"type\":\"float\",\n\"column\":\"2.5%\"\n},{\n\"type\":\"float\",\n\"column\":\"97.5%\"\n},{\n\"type\":\"float\",\n\"column\":\"N\"\n},{\n\"type\":\"str\",\n\"column\":\"Model\"\n}]\n},\n\"guides\":{\n\"y\":{\n\"title\":\"Estimate and 95.0% Confidence Interval\"\n}\n},\n\"ggsize\":{\n\"width\":1200.0,\n\"height\":400.0\n},\n\"theme\":{\n\"axis_text_x\":{\n\"angle\":0.0,\n\"blank\":false\n}\n},\n\"ggtitle\":{\n\"text\":\"Local-Projections-Estimator\"\n},\n\"kind\":\"plot\",\n\"scales\":[],\n\"layers\":[{\n\"geom\":\"point\",\n\"mapping\":{\n},\n\"position\":{\n\"name\":\"dodge\",\n\"width\":0.5\n},\n\"data_meta\":{\n},\n\"data\":{\n}\n},{\n\"geom\":\"errorbar\",\n\"mapping\":{\n\"ymin\":\"2.5%\",\n\"ymax\":\"97.5%\"\n},\n\"position\":{\n\"name\":\"dodge\",\n\"width\":0.5\n},\n\"data_meta\":{\n},\n\"width\":0.05,\n\"data\":{\n}\n},{\n\"geom\":\"hline\",\n\"mapping\":{\n},\n\"data_meta\":{\n},\n\"yintercept\":0.0,\n\"linetype\":\"dashed\",\n\"color\":\"black\",\n\"data\":{\n}\n},{\n\"geom\":\"vline\",\n\"mapping\":{\n},\n\"data_meta\":{\n},\n\"xintercept\":18.5,\n\"linetype\":\"dashed\",\n\"color\":\"black\",\n\"data\":{\n}\n}],\n\"metainfo_list\":[],\n\"spec_id\":\"4\"\n};\n           window.letsPlotCall(function() { fig = LetsPlot.buildPlotFromProcessedSpecs(plotSpec, containerDiv, sizing); });\n       } else {\n           fig.updateView({});\n       }\n   }\n   \n   const renderImmediately = \n       forceImmediateRender || (\n           sizing.width_mode === 'FIXED' && \n           (sizing.height_mode === 'FIXED' || sizing.height_mode === 'SCALED')\n       );\n   \n   if (renderImmediately) {\n       renderPlot();\n   }\n   \n   if (!renderImmediately || responsive) {\n       // Set up observer for initial sizing or continuous monitoring\n       var observer = new ResizeObserver(function(entries) {\n           for (let entry of entries) {\n               if (entry.contentBoxSize && \n                   entry.contentBoxSize[0].inlineSize > 0) {\n                   if (!responsive && observer) {\n                       observer.disconnect();\n                       observer = null;\n                   }\n                   renderPlot();\n                   if (!responsive) {\n                       break;\n                   }\n               }\n           }\n       });\n       \n       observer.observe(containerDiv);\n   }\n   \n   // ----------\n   })();\n   \n   </script>\n```\n:::\n:::\n\n\nWhat if we are not interested in the ATT per treatment period, but in a pooled effects?\n\n::: {#48b8d3b1 .cell execution_count=24}\n``` {.python .cell-code}\nfit_twfe = pf.feols(\n    \"dep_var ~ i(treat) | unit + year\",\n    df_multi_cohort,\n    vcov={\"CRV1\": \"state\"},\n)\n\nfit_did2s = pf.did2s(\n    df_multi_cohort,\n    yname=\"dep_var\",\n    first_stage=\"~ 0 | unit + year\",\n    second_stage=\"~i(treat)\",\n    treatment=\"treat\",\n    cluster=\"state\",\n)\n\nfit_lpdid = pf.lpdid(\n    data=df_multi_cohort,\n    yname=\"dep_var\",\n    gname=\"g\",\n    tname=\"year\",\n    idname=\"unit\",\n    vcov={\"CRV1\": \"state\"},\n    pre_window=-20,\n    post_window=20,\n    att=True,\n)\npd.concat(\n    [\n        fit_twfe.tidy().assign(estimator=\"TWFE\"),\n        fit_did2s.tidy().assign(estimator=\"DID2s\"),\n        fit_lpdid.tidy().assign(estimator=\"LPDID\").drop(\"N\", axis=1),\n    ],\n    axis=0,\n)\n```\n\n::: {.cell-output .cell-output-display execution_count=24}\n```{=html}\n<div>\n<style scoped>\n    .dataframe tbody tr th:only-of-type {\n        vertical-align: middle;\n    }\n\n    .dataframe tbody tr th {\n        vertical-align: top;\n    }\n\n    .dataframe thead th {\n        text-align: right;\n    }\n</style>\n<table border=\"1\" class=\"dataframe\">\n  <thead>\n    <tr style=\"text-align: right;\">\n      <th></th>\n      <th>Estimate</th>\n      <th>Std. Error</th>\n      <th>t value</th>\n      <th>Pr(&gt;|t|)</th>\n      <th>2.5%</th>\n      <th>97.5%</th>\n      <th>estimator</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <th>treat::True</th>\n      <td>1.982540</td>\n      <td>0.019338</td>\n      <td>102.521988</td>\n      <td>0.0</td>\n      <td>1.943426</td>\n      <td>2.021655</td>\n      <td>TWFE</td>\n    </tr>\n    <tr>\n      <th>treat::True</th>\n      <td>2.230482</td>\n      <td>0.024709</td>\n      <td>90.271446</td>\n      <td>0.0</td>\n      <td>2.182052</td>\n      <td>2.278911</td>\n      <td>DID2s</td>\n    </tr>\n    <tr>\n      <th>treat_diff</th>\n      <td>2.506746</td>\n      <td>0.071420</td>\n      <td>35.098900</td>\n      <td>0.0</td>\n      <td>2.362287</td>\n      <td>2.651206</td>\n      <td>LPDID</td>\n    </tr>\n  </tbody>\n</table>\n</div>\n```\n:::\n:::\n\n\n",
    "supporting": [
      "difference-in-differences_files"
    ],
    "filters": [],
    "includes": {
      "include-in-header": [
        "<script src=\"https://cdn.jsdelivr.net/npm/requirejs@2.3.6/require.min.js\" integrity=\"sha384-c9c+LnTbwQ3aujuU7ULEPVvgLs+Fn6fJUvIGTsuu1ZcCf11fiEubah0ttpca4ntM sha384-6V1/AdqZRWk1KAlWbKBlGhN7VG4iE/yAZcO6NZPMF8od0vukrvr0tg4qY6NSrItx\" crossorigin=\"anonymous\"></script>\n<script src=\"https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js\" integrity=\"sha384-ZvpUoO/+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn/6Z/hRTt8+pR6L4N2\" crossorigin=\"anonymous\" data-relocate-top=\"true\"></script>\n<script type=\"application/javascript\">define('jquery', [],function() {return window.jQuery;})</script>\n"
      ]
    }
  }
}